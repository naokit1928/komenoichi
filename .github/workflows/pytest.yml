name: pytest
on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Show Python and OS info
        run: |
          python -V
          which python
          uname -a
          pip -V
          git rev-parse HEAD
          echo "GITHUB_SHA=$GITHUB_SHA"

      - name: Install dependencies (fixed list)
        run: |
          python -m pip install --upgrade pip
          pip install fastapi uvicorn sqlalchemy "pydantic>=2" "pydantic-settings>=2.3" python-dotenv pytest httpx
          pip show pydantic-settings || true
          python - << 'PY'
          import pkgutil
          print("pydantic_settings loader:", pkgutil.find_loader("pydantic_settings"))
          PY

      - name: Debug repo state (show database.py on runner)
        run: |
          echo "== begin: app/database.py (head 80 lines) =="
          sed -n '1,80p' app/database.py || true
          echo "== end: app/database.py =="
          echo "== grep for top-level imports =="
          nl -ba app/database.py | grep -n "from pydantic_settings import BaseSettings" || true

      - name: Which app/database.py actually gets imported?
        run: |
          python - << 'PY'
          import importlib, inspect
          m = importlib.import_module("app")
          print("app module file:", inspect.getfile(m))
          md = importlib.import_module("app.database")
          print("app.database file:", inspect.getfile(md))
          # Print first 40 lines of the imported file to ensure content
          import itertools
          with open(inspect.getfile(md), "r", encoding="utf-8", errors="ignore") as f:
              print("== imported app.database head ==")
              print("".join(list(itertools.islice(f, 40))))
          PY

      - name: Run tests
        run: pytest -v
