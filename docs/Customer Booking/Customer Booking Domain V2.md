 stripe listen --forward-to localhost:8000/stripe/webhook 

Customer Booking Domain V2
0. äº‹å‰ç¢ºå®šäº‹é …ï¼ˆ2025-11-21 æ™‚ç‚¹ï¼‰
A. ä¸€è¦§ãƒšãƒ¼ã‚¸ï¼ˆPublic Farm Listï¼‰ä»•æ§˜

1ãƒšãƒ¼ã‚¸ 8ä»¶ ãƒ­ãƒ¼ãƒ‰

ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ–¹å¼ï¼ˆAirbnb å½¢å¼ï¼‰

ä¸¦ã³é †ã¯ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½ç½®ã‹ã‚‰ã®è·é›¢é †ï¼ˆHaversineï¼‰

ä½ç½®å–å¾—ä¸å¯ â†’ IPæ¨å®š â†’ ãã‚Œã‚‚ä¸å¯ãªã‚‰å¾³å³¶çœŒä¸­å¿ƒ

100km åœå†…0ä»¶ã§ã‚‚å¿…ãšè¡¨ç¤ºï¼ˆè·é›¢é †ï¼‰

no_farms_within_100km = true ã®å ´åˆã¯ä¸Šéƒ¨ã«æ³¨æ„æ–‡ã‚’è¡¨ç¤º

PRç”»åƒã¯ ä¸€è¦§ã§ã¯1æšã®ã¿ï¼ˆpr_images[0]ï¼‰

åœ°å›³ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯ V1ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å®Œå…¨ã«ç¶­æŒ

åœ°å›³ãƒ”ãƒ³ã®åº§æ¨™ã¯ pickup_lat / pickup_lng

åœ°å›³ã¨ä¸€è¦§ã¯ åŒã˜ PublicFarmCardDTO[] ã‚’å…±æœ‰

B. PublicFarmCardDTO ä»•æ§˜ï¼ˆä¸€è¦§ãƒ»åœ°å›³å…±é€šï¼‰

farm_id ã¯ãã®ã¾ã¾ä½¿ç”¨

åå‰ï¼ä½æ‰€ã®ãƒ©ãƒ™ãƒ«ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§ä½œæˆ

owner_label = owner_full_name + "ã•ã‚“ã®ãŠç±³"

owner_address_label = éƒ½é“åºœçœŒ + å¸‚åŒºç”ºæ‘ + ç”ºåŸŸ + "ã®è¾²å®¶"

pr_title ã¯ å¿…é ˆ

pickup_slot_code â†’ æ¬¡å›å—ã‘æ¸¡ã—æ—¥æ™‚ã®è¨ˆç®—ã«ä½¿ç”¨

æ¬¡å›å—ã‘æ¸¡ã—æ—¥æ™‚ã¯ ç· åˆ‡3æ™‚é–“å‰ãƒ«ãƒ¼ãƒ«

åœ°å›³ãƒ¢ãƒ¼ãƒ€ãƒ«ã«æ¸¡ã™ props ã¯ä»¥ä¸‹

type MapLayerPortalProps = {
  open: boolean;
  onRequestClose: () => void;
  farms: PublicFarmCardDTO[];
  mapCenter: { lat: number; lng: number };
  noFarmsWithin100km: boolean;
};

C. åœ°å›³ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä¸‹éƒ¨ã‚·ãƒ¼ãƒˆ

face_image_url

owner_label

owner_address_label

price_10kg

next_pickup_display

pr_title

ã€Œè©³ç´°ã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³

ã“ã‚Œä»¥å¤–ã®é …ç›®ï¼ˆgood, deals, attendanceï¼‰ã¯å®Œå…¨å‰Šé™¤ãƒ»ç—•è·¡ãªã—ã€‚

D. è¨­è¨ˆæ€æƒ³

UI ãŒå¿…è¦ã¨ã™ã‚‹ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ DTO ã«å®Œå…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã—ã¦è¿”ã™

ãƒ•ãƒ­ãƒ³ãƒˆå´ã§ã¯ ä¸€åˆ‡è¨ˆç®—ã—ãªã„

Farmer Domain V2 ã®ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥å‚ç…§ã—ãªã„


1. ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ç›®çš„ã¨ã‚¹ã‚³ãƒ¼ãƒ—
1-1. ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ç›®çš„

ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¾²å®¶ã‚’æ¢ã—ã€å—ã‘æ¸¡ã—æ—¥æ™‚ã‚’ç¢ºèªã—ã€äºˆç´„ãƒ»æ±ºæ¸ˆã¾ã§ã‚¹ãƒ ãƒ¼ã‚ºã«è¡Œãˆã‚‹ UI/UX ã® V2 ã‚’è¨­è¨ˆã™ã‚‹ã€ã€‚

ç¯„å›²ã¯ï¼š

è¾²å®¶ä¸€è¦§

è¾²å®¶è©³ç´°

äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ 

Stripe æ±ºæ¸ˆ

äºˆç´„å®Œäº†ãƒšãƒ¼ã‚¸

1-2. å‰æ

äºˆç´„ãƒ»æ±ºæ¸ˆãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã€ŒçœŸå®Ÿã®ã‚½ãƒ¼ã‚¹ã€ã¯ã™ã¹ã¦ V2ï¼ˆæœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰ã¨ã™ã‚‹ã€‚V1 å®Ÿè£…ãƒ»ã‚«ãƒ©ãƒ ã¯éå»ãƒ‡ãƒ¼ã‚¿å‚ç…§ç”¨ã¨ã—ã¦æ®‹ã™ãŒã€æ–°è¦æ©Ÿèƒ½ã‚„ UI ã¯ V2 ã® DTO / ãƒ†ãƒ¼ãƒ–ãƒ«ä»•æ§˜ã®ã¿ã‚’å‰æã«è¨­è¨ˆãƒ»å®Ÿè£…ã™ã‚‹ã€‚

ã¾ãŸ 2025-11-24 æ™‚ç‚¹ã§ã€ã‚µãƒ¼ãƒãƒ¼å´ã® app_v1 ãƒ•ã‚©ãƒ«ãƒ€ã¯å‰Šé™¤æ¸ˆã¿ã§ã‚ã‚Šã€
Public APIï¼ˆä¸€è¦§ãƒ»è©³ç´°ï¼‰ã€äºˆç´„ä½œæˆã€LINEé€£æºã€Stripe æ±ºæ¸ˆãƒ»Webhook ã‚’å«ã‚€
ä¸€é€£ã®ãƒ•ãƒ­ãƒ¼ã¯ã™ã¹ã¦ app_v2 é…ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã®ã¿ã§å‹•ä½œã—ã¦ã„ã‚‹ã€‚
V1 ã®ã‚³ãƒ¼ãƒ‰ã¯ä»Šå¾Œã‚‚å‚ç…§ã•ã‚Œãªã„å‰æã§ã€æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å”¯ä¸€ã®ä»•æ§˜ã¨ã—ã¦æ‰±ã†ã€‚


Farmer Domain V2ï¼ˆRegistration / Pickup / Settingsï¼‰ã¯å®Œæˆæ¸ˆã¿

å…¬é–‹æ¡ä»¶ã¯ Farmer Domain V2 ã®

active_flag

is_accepting_reservations

is_ready_to_publish
ã‚’ãã®ã¾ã¾ä½¿ç”¨ã™ã‚‹

äºˆç´„ãƒ»æ±ºæ¸ˆãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã€ŒçœŸå®Ÿã®ã‚½ãƒ¼ã‚¹ã€ã¯ã™ã¹ã¦ V2ï¼ˆæœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰ã¨ã™ã‚‹ã€‚V1 å®Ÿè£…ãƒ»ã‚«ãƒ©ãƒ ã¯éå»ãƒ‡ãƒ¼ã‚¿å‚ç…§ç”¨ã¨ã—ã¦æ®‹ã™ãŒã€æ–°è¦æ©Ÿèƒ½ã‚„ UI ã¯ V2 ã® DTO / ãƒ†ãƒ¼ãƒ–ãƒ«ä»•æ§˜ã®ã¿ã‚’å‰æã«è¨­è¨ˆãƒ»å®Ÿè£…ã™ã‚‹ã€‚

2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒšãƒ«ã‚½ãƒŠã¨ä½“é¨“ãƒ•ãƒ­ãƒ¼
2-1. ãƒšãƒ«ã‚½ãƒŠ

æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆè¾²å®¶ç›´é€ã®ç±³ã‚’è²·ã„ãŸã„äººï¼‰

ãƒªãƒ”ãƒ¼ã‚¿ãƒ¼ï¼ˆæ±ºæ¸ˆå¾Œã€å†åº¦åŒã˜è¾²å®¶ã‚’äºˆç´„ã—ãŸã„äººï¼‰

2-2. å…¸å‹ãƒ•ãƒ­ãƒ¼

ä¸€è¦§ â†’ è©³ç´° â†’ äºˆç´„ â†’ æ±ºæ¸ˆ â†’ å®Œäº†

è©³ç´° â†’ äºˆç´„ ã¸ç›´æ¥é·ç§»ã‚‚å¯


3. ãƒšãƒ¼ã‚¸åˆ¥ä»•æ§˜
3-1. è¾²å®¶ä¸€è¦§ãƒšãƒ¼ã‚¸ï¼ˆPublic Farm Listï¼‰
ğŸ¯ç›®çš„

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ æ¬¡å›å—ã‘æ¸¡ã—æ—¥æ™‚ã¨ä¾¡æ ¼ã‚’åŸºæº–ã«ç›´æ„Ÿçš„ã«è¾²å®¶ã‚’é¸ã¹ã‚‹ã“ã¨ã€‚

ğŸ§±ã‚«ãƒ¼ãƒ‰ã«å¿…è¦ãªé …ç›®ï¼ˆè¡¨ç¤ºé †ï¼‰

owner_labelï¼ˆå±±ç”°å¤ªéƒã•ã‚“ã®ãŠç±³ï¼‰

owner_address_labelï¼ˆå¾³å³¶çœŒé˜¿å—å¸‚è¦‹èƒ½æ—ã®è¾²å®¶ï¼‰

face_image_urlï¼ˆä¸¸ï¼‰

price_10kgï¼ˆÂ¥8,700ï¼‰

next_pickup_displayï¼ˆ11/27ï¼ˆæ°´ï¼‰19:00â€“20:00ï¼‰

pr_title

PRç”»åƒï¼špr_images[0]

ğŸ§­ ãã®ä»–ä»•æ§˜

ä¸¦ã³é †ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ä½ç½®ã‹ã‚‰ã®Haversineè·é›¢ã§æ˜‡é †

100kmä»¥å†…ã„ãªã„å ´åˆï¼šæ³¨æ„æ–‡ï¼‹è·é›¢é †è¡¨ç¤º

ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼š8ä»¶ãšã¤ fetch



ğŸ“Œã€è¿½è¨˜ç”¨ï¼šç”»åƒã®ä½¿ã„åˆ†ã‘ä»•æ§˜ï¼ˆä¸€è¦§ãƒ»åœ°å›³ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€šï¼‰ã€‘
E. ç”»åƒã®ä½¿ã„åˆ†ã‘ï¼ˆä¸€è¦§ã¨åœ°å›³ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ˜ç¢ºãªå½¹å‰²åˆ†æ‹…ï¼‰

æœ¬ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’æœ€é©åŒ–ã™ã‚‹ãŸã‚ã€
PRç”»åƒï¼ˆå•†å“ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰ ã¨
é¡”ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆè¾²å®¶ã®å€‹æ€§ï¼‰
ã‚’å½¹å‰²ã«å¿œã˜ã¦ä½¿ã„åˆ†ã‘ã‚‹ã€‚

1. è¾²å®¶ä¸€è¦§ãƒšãƒ¼ã‚¸ï¼ˆPublic Farm Listï¼‰ã§ã®ç”»åƒä»•æ§˜
ğŸ–¼ ä¸Šéƒ¨ã®å¤§ãã„ç”»åƒï¼ˆãƒ¯ã‚¤ãƒ‰å†™çœŸï¼‰

ä½¿ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼špr_images[0]

å½¹å‰²ï¼šå•†å“ï¼ˆç±³ï¼‰ã¨è¾²å®¶ã®é›°å›²æ°—ãŒæœ€ã‚‚ä¼ã‚ã‚‹ä¸»è¦ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«

è¡¨ç¤ºä¾‹ï¼šç¨²åˆˆã‚Šé¢¨æ™¯ / ç”°ã‚“ã¼ / ä½œæ¥­å†™çœŸ ãªã©

ä»•æ§˜ï¼šãƒ•ãƒ«å¹…ã€Airbnb å‹ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³

ğŸ‘¤ åå‰æ¨ªã®å°ã•ãªä¸¸ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆé¡”å†™çœŸï¼‰

ä½¿ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼šface_image_url

å½¹å‰²ï¼šã€Œèª°ãŒä½œã£ã¦ã„ã‚‹ã‹ã€ã‚’ç›´æ„Ÿçš„ã«ä¼ãˆã‚‹

è¡¨ç¤ºä½ç½®ï¼šowner_label ã®å·¦å´

è¡¨ç¤ºå½¢çŠ¶ï¼šä¸¸ãƒã‚¹ã‚¯ï¼ˆæ—¢å­˜ã® V1 ã¨åŒã˜ï¼‰

ä¸€è¦§ã‚«ãƒ¼ãƒ‰ã¯ã“ã® â€œPRç”»åƒï¼‹é¡”ä¸¸ã‚¢ã‚¤ã‚³ãƒ³â€ ã®çµ„ã¿åˆã‚ã›ã§çµ±ä¸€ã™ã‚‹ã€‚

2. åœ°å›³ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆMapLayerPortalï¼‰ã§ã®ç”»åƒä»•æ§˜
ğŸ—º å·¦å´ã®å¤§ãã„é ˜åŸŸï¼ˆFarm 3 ã¨è¡¨ç¤ºã•ã‚Œã¦ã„ãŸéƒ¨åˆ†ï¼‰

V2ã§ã¯ã“ã®é ˜åŸŸã®èƒŒæ™¯ç”»åƒã‚’
pr_images[0]ï¼ˆPRå†™çœŸï¼‰ã§å®Œå…¨ã«ç½®ãæ›ãˆã‚‹

å½¹å‰²ï¼šãƒãƒƒãƒ—é¸æŠæ™‚ã«ã€Œè¾²å®¶ã®å“è³ªãƒ»é›°å›²æ°—ã€ã‚’å¼·ãä¼ãˆã‚‹ãƒ¡ã‚¤ãƒ³ç”»åƒ

ä»•æ§˜ï¼šV1 ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ»ã‚µã‚¤ã‚ºãƒ»ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯ãã®ã¾ã¾ç¶­æŒ

ğŸ‘¤ face_image_url ã¯åœ°å›³ä¸‹éƒ¨ã‚·ãƒ¼ãƒˆã§ã¯ä½¿ç”¨ã—ãªã„

ä¸‹éƒ¨ã‚·ãƒ¼ãƒˆã«ã¯é¡”ã‚¢ã‚¤ã‚³ãƒ³ã¯ç½®ã‹ãšã€
ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ï¼ˆåå‰ãƒ»ä½æ‰€ãƒ»ä¾¡æ ¼ãƒ»å—æ¸¡æ—¥æ™‚ãƒ»PRã‚¿ã‚¤ãƒˆãƒ«ï¼‰ã‚’ä¸­å¿ƒã«é…ç½®ã™ã‚‹

ä¸€è¦§ â†’ åœ°å›³ãƒ¢ãƒ¼ãƒ€ãƒ«ã¸ã®é·ç§»ã§
ã€Œä¸€è¦§ï¼šäººã®é¡”ã€ã€Œåœ°å›³ï¼šPRç”»åƒã€ ã®å½¹å‰²åˆ†æ‹…ãŒæ˜ç¢ºã«ãªã‚‹

3. åœ°å›³ãƒ¢ãƒ¼ãƒ€ãƒ«ä¸‹éƒ¨ã‚·ãƒ¼ãƒˆã®è¡¨ç¤ºé …ç›®ï¼ˆç”»åƒä»¥å¤–ã®è¦ç´ ï¼‰

é †ç•ªã¨å†…å®¹ã¯ä»¥ä¸‹ã§å›ºå®šã™ã‚‹ï¼š

owner_labelï¼ˆä¾‹ï¼šå±±ç”°å¤ªéƒã•ã‚“ã®ãŠç±³ï¼‰

owner_address_labelï¼ˆå¾³å³¶çœŒé˜¿å—å¸‚è¦‹èƒ½æ—ã®è¾²å®¶ï¼‰

price_10kgï¼ˆÂ¥8,700 (10kg)ï¼‰

next_pickup_displayï¼ˆ11/27ï¼ˆæ°´ï¼‰19:00â€“20:00ï¼‰

pr_titleï¼ˆçŸ­ã„ç´¹ä»‹æ–‡ï¼‰

ã€Œè©³ç´°ã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³

â€» good / deals / attendance ã¯å®Œå…¨å‰Šé™¤ã€ç—•è·¡ãªã—

4. ç”»åƒåˆ©ç”¨ã®ã¾ã¨ã‚ï¼ˆæœ€çµ‚ç‰ˆï¼‰
ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ	PRç”»åƒï¼ˆpr_images[0]ï¼‰	é¡”å†™çœŸï¼ˆface_image_urlï¼‰
ä¸€è¦§ã‚«ãƒ¼ãƒ‰	âœ” å¤§ãã„ãƒ¡ã‚¤ãƒ³ç”»åƒ	âœ” å°ã•ãªä¸¸ã‚¢ã‚¤ã‚³ãƒ³
åœ°å›³ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå·¦ã®å¤§ç”»åƒï¼‰	âœ” å®Œå…¨ã« PRç”»åƒã§çµ±ä¸€	âœ– ä½¿ç”¨ã—ãªã„
åœ°å›³ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆä¸‹éƒ¨ã‚·ãƒ¼ãƒˆï¼‰	âœ– ä½¿ç”¨ã—ãªã„	âœ– ä½¿ç”¨ã—ãªã„ï¼ˆç”»åƒã¯ç½®ã‹ãªã„ï¼‰

ä¸€è¦§ï¼å•†å“ã‚’è¦‹ã‚„ã™ãã€äººã‚’ç¢ºèªã§ãã‚‹
åœ°å›³ï¼å•†å“ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å¼·ãä¼ãˆã‚‹

ã¨ã„ã† å½¹å‰²åˆ†æ‹…ã§ UX ãŒæœ€å¤§åŒ–ã•ã‚Œã‚‹ã€‚

3-2. åœ°å›³ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆMapLayerPortalï¼‰
ğŸ¯ç›®çš„

ã€Œä½ç½®ã§æ¢ã™ã€UXã‚’æä¾›ã™ã‚‹ãŒã€ãƒ‡ã‚¶ã‚¤ãƒ³ã¯V1ãã®ã¾ã¾ã€‚

ğŸ“¦ propsï¼ˆç¢ºå®šï¼‰
{
  open,
  onRequestClose,
  farms: PublicFarmCardDTO[],
  mapCenter: { lat, lng },
  noFarmsWithin100km
}

ğŸ“Œ ãƒ”ãƒ³ã®ä»•æ§˜

bubbleã« Â¥{price_10kg} ã‚’è¡¨ç¤º

activeæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯ãã®ã¾ã¾

ğŸ“Œ ä¸‹éƒ¨ã‚·ãƒ¼ãƒˆï¼ˆè©³ç´°ãƒŸãƒ‹ãƒ“ãƒ¥ãƒ¼ï¼‰

face_image_url

owner_label

owner_address_label

price_10kg

next_pickup_display

pr_title

ã€Œè©³ç´°ã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³

â€» Good / Deals / Attendance ã¯å®Œå…¨ã«å‰Šé™¤ã€‚

3-3. è¾²å®¶è©³ç´°ãƒšãƒ¼ã‚¸ï¼ˆPublic Farm Detailï¼‰

åˆ¥é€” PublicFarmDetailDTO ã§å®šç¾©ã™ã‚‹ãŒã€ä¸€è¦§ã‚«ãƒ¼ãƒ‰ã¨å…±é€šé …ç›®ã¯ï¼š

owner_label

owner_address_label

next_pickup_display

pr_title

pr_imagesï¼ˆå…¨æšï¼‰

ä¾¡æ ¼è¡¨ï¼ˆ5kg/10kg/25kgï¼‰

å“ç¨®ãƒ©ãƒ™ãƒ«

è‡ªå‹•è¨ˆç®— harvest_year

ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—å ´æ‰€ï¼ˆä½æ‰€ï¼‹åœ°å›³ï¼‰

3-4. äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ãƒšãƒ¼ã‚¸

é¸æŠå¯èƒ½kgï¼ˆ5kg/10kg/25kgï¼‰

next_pickup_start / deadline

æŒ‡å®šã•ã‚ŒãŸã‚¹ãƒ­ãƒƒãƒˆï¼ˆpickup_slot_codeï¼‰

ãƒ¦ãƒ¼ã‚¶ãƒ¼é€£çµ¡å…ˆï¼ˆé›»è©±ãƒ»ãƒ¡ãƒ¼ãƒ«ï¼‰

3-5. Stripe æ±ºæ¸ˆãƒ•ãƒ­ãƒ¼

ä¾¡æ ¼ã¯ DTO â†’ API ã§ç¢ºå®š

æ±ºæ¸ˆ â†’ Webhook â†’ äºˆç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ confirmed

3-6. äºˆç´„å®Œäº†ãƒšãƒ¼ã‚¸

äºˆç´„ID

farm_id

next_pickup_display

å—ã‘æ¸¡ã—å ´æ‰€ï¼ˆä½æ‰€ï¼‰

4. DTO è¨­è¨ˆ
4-1. PublicFarmCardDTOï¼ˆä¸€è¦§ãƒ»åœ°å›³å…±é€šï¼‰

âœ” æœ€æ–°ç‰ˆï¼ˆã‚ãªãŸã®å¸Œæœ›ã©ãŠã‚Šï¼‰

export type PublicFarmCardDTO = {
  farm_id: number;

  owner_full_name: string;      // å±±ç”°å¤ªéƒ
  owner_label: string;          // å±±ç”°å¤ªéƒã•ã‚“ã®ãŠç±³
  owner_address_label: string;  // å¾³å³¶çœŒé˜¿å—å¸‚è¦‹èƒ½æ—ã®è¾²å®¶

  price_10kg: number;

  face_image_url: string;
  pr_images: string[];
  pr_title: string;

  pickup_slot_code: string;

  next_pickup_display: string;
  next_pickup_start: string;     // ISO
  next_pickup_deadline: string;  // ISO

  pickup_lat: number;
  pickup_lng: number;
};

è£œè¶³ï¼š
next_pickup_start / next_pickup_deadline / next_pickup_display ã¯ã€
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã®å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

- app_v2/customer_booking/services/pickup_time_utils.py ã® compute_next_pickup()

ã«ã‚ˆã£ã¦ä¸€å…ƒçš„ã«è¨ˆç®—ã•ã‚Œã‚‹ã€‚PublicFarmList API ã¨ Reservation API
ï¼ˆ/api/reservationsï¼‰ã¯å¿…ãšã“ã®é–¢æ•°ã‚’å‚ç…§ã—ã€3æ™‚é–“å‰ç· åˆ‡ãƒ«ãƒ¼ãƒ«ã‚’
å®Œå…¨ã«å…±æœ‰ã™ã‚‹ã€‚


4-2. PublicFarmDetailDTO

è¾²å®¶è©³ç´°ãƒšãƒ¼ã‚¸ï¼ˆ/farms/{farm_id}ï¼‰å°‚ç”¨ã® DTOã€‚
ä¸€è¦§ã‚«ãƒ¼ãƒ‰ã¨å…±é€šã®é …ç›®ã«åŠ ãˆã¦ã€ä¾¡æ ¼è¡¨ï¼ˆ5/10/25kgï¼‰ã€å“ç¨®ãƒ©ãƒ™ãƒ«ã€åç©«å¹´åº¦ã€ä½æ‰€ãƒ†ã‚­ã‚¹ãƒˆã€ãƒŸãƒ‹ãƒãƒƒãƒ—åº§æ¨™ã€å…±æœ‰URLãªã©ã‚’å«ã‚€ã€‚

// ä¸€è¦§ã‚«ãƒ¼ãƒ‰ã¨å…±é€šã®é …ç›®
export type PublicFarmDetailDTO = {
  farm_id: number;

  // è¡¨ç¤ºãƒ©ãƒ™ãƒ«ï¼ˆæ„å‘³ãƒ™ãƒ¼ã‚¹ï¼‰
  owner_full_name: string;      // ä¾‹: "å±±ç”°å¤ªéƒ"
  owner_label: string;          // ä¾‹: "å±±ç”°å¤ªéƒã•ã‚“ã®ãŠç±³"
  owner_address_label: string;  // ä¾‹: "å¾³å³¶çœŒé˜¿å—å¸‚è¦‹èƒ½æ—ã®è¾²å®¶"

  // ä»£è¡¨ä¾¡æ ¼ï¼ˆ10kgï¼‰
  price_10kg: number | null;

  // ç”»åƒãƒ»ã‚¿ã‚¤ãƒˆãƒ«
  face_image_url: string;   // ä¸¸ã‚¢ã‚¤ã‚³ãƒ³ç”¨
  pr_images: string[];      // ã™ã¹ã¦ã®PRç”»åƒï¼ˆ0æšä»¥ä¸Šï¼‰
  pr_title: string;         // PRã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå¿…é ˆé‹ç”¨ï¼‰

  // å—ã‘æ¸¡ã—ã‚¹ãƒ­ãƒƒãƒˆï¼ˆä¸€è¦§ã¨åŒã˜ï¼‰
  pickup_slot_code: string;     // ä¾‹: "WED_19_20"
  next_pickup_display: string;  // ä¾‹: "11/27ï¼ˆæ°´ï¼‰19:00â€“20:00"
  next_pickup_start: string;    // ISOæ–‡å­—åˆ—
  next_pickup_deadline: string; // ISOæ–‡å­—åˆ—

è£œè¶³ï¼š
ã“ã‚Œã‚‰ã®å—ã‘æ¸¡ã—ã‚¹ãƒ­ãƒƒãƒˆé–¢é€£ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ã€
app_v2/customer_booking/services/pickup_time_utils.py ã®
compute_next_pickup() ã«ã‚ˆã£ã¦ç®—å‡ºã•ã‚Œã‚‹ã€‚
PublicFarmCardDTO ã¨ PublicFarmDetailDTO ã§åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’å…±æœ‰ã—ã€
ä¸€è¦§ãƒ»è©³ç´°ãƒ»Confirmãƒ»äºˆç´„APIã®é–“ã§æ¬¡å›å—ã‘æ¸¡ã—æ—¥æ™‚ï¼ç· åˆ‡ãŒ
å¿…ãšä¸€è‡´ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚



  pickup_lat: number;
  pickup_lng: number;

  // ===== ã“ã“ã‹ã‚‰è©³ç´°ãƒšãƒ¼ã‚¸å°‚ç”¨ã®è¿½åŠ é …ç›® =====

  // ä¾¡æ ¼è¡¨ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç¢ºå®šå€¤ãƒ»äºˆç´„æ™‚ã«ä½¿ç”¨ã™ã‚‹å˜ä¾¡ã®å…ƒï¼‰
  price_5kg: number | null;   // farms.price_5kg ã‹ã‚‰ãã®ã¾ã¾
  price_25kg: number | null;  // farms.price_25kg ã‹ã‚‰ãã®ã¾ã¾

  // å“ç¨®ãƒ©ãƒ™ãƒ«ãƒ»åç©«å¹´åº¦
  rice_variety_label: string | null; // ä¾‹: "ã‚³ã‚·ãƒ’ã‚«ãƒª"
  harvest_year: number | null;       // ä¾‹: 2025ï¼ˆnull ã®å ´åˆã¯ãƒ•ãƒ­ãƒ³ãƒˆã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç®—å¯ï¼‰

  // ä½æ‰€ãƒ†ã‚­ã‚¹ãƒˆï¼ˆãƒ•ãƒ«ï¼‰
  address_text: string;  // ä¾‹: "å¾³å³¶çœŒå¾³å³¶å¸‚ä¼Šæœˆç”º1ä¸ç›®14-1 â—‹â—‹ãƒãƒ³ã‚·ãƒ§ãƒ³101å·å®¤"

  // ãƒŸãƒ‹ãƒãƒƒãƒ—ä¸­å¿ƒåº§æ¨™ï¼ˆpickup_lat/lng ã¨åŒã˜ã§ã‚‚ã‚ˆã„ï¼‰
  center_lat: number;
  center_lng: number;

  // å—ã‘æ¸¡ã—æ—¥æ™‚æ–‡è¨€ï¼ˆä¸‹éƒ¨CTAç”¨ï¼‰
  // ä¾‹: "11/27ï¼ˆæ°´ï¼‰19:00â€“20:00" / "å—ã‘æ¸¡ã—æ—¥æ™‚ã¯æœªè¨­å®šã§ã™" ãªã©
  // ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆå´ã§ã¯ pickupTextCard / pickupTextCTA ã®å…ƒã«ãªã‚‹ï¼‰
  pickup_time: string | null;

  // PRæœ¬æ–‡ï¼ˆä»»æ„ï¼‰
  pr_text: string | null;

  // è©•ä¾¡ãƒ»å®Ÿç¸¾ï¼ˆç¾çŠ¶ã¯ãƒ€ãƒŸãƒ¼ç„¡ã—ã€å°†æ¥æ‹¡å¼µã‚’å‰æã« null è¨±å®¹ï¼‰
  good_rate: number | null;    // 0â€“100 ã®ç™¾åˆ†ç‡
  deals_count: number | null;  // å–å¼•ä»¶æ•°

  // å…±æœ‰ç”¨URLï¼ˆãªã‘ã‚Œã°ãƒ•ãƒ­ãƒ³ãƒˆã§ window.location.href ã‚’ä½¿ã†ï¼‰
  share_url: string | null;
};

FarmDetailPage å´ã®å®Ÿè£…ï¼ˆ2025-11-23 æ™‚ç‚¹ï¼‰

- `/farms/{farm_id}` ã¯ **PublicFarmDetailDTO ã‚’ 1:1 ã§å—ã‘å–ã‚Šè¡¨ç¤ºã™ã‚‹ V2 å®Ÿè£…** ã«å®Œå…¨ç§»è¡Œã—ãŸã€‚
- ä¾¡æ ¼ã¯ DTO ã«å«ã¾ã‚Œã‚‹ `price_5kg / price_10kg / price_25kg` ã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã€
  æ—§æ¥ã® `pricing/preview` API ã‚„ãƒ•ãƒ­ãƒ³ãƒˆå´ã§ã®å†è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã«ã¯ä¸€åˆ‡ä¾å­˜ã—ãªã„ã€‚
- DTO ã«å«ã¾ã‚Œã‚‹ `harvest_year / rice_variety_label / pickup_lat / pickup_lng /
  pickup_address_label / pr_title / pr_text / pr_images / face_image_url` ã‚‚ã€
  FarmDetailPage å†…ã®å„ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»ä¾¡æ ¼ãƒ»å—ã‘æ¸¡ã—æ™‚é–“ãƒ»åœ°å›³ãªã©ï¼‰ã«
  ãã®ã¾ã¾æ¸¡ã—ã¦è¡¨ç¤ºã—ã¦ã„ã‚‹ã€‚
- å…¬é–‹æ¡ä»¶ãƒã‚§ãƒƒã‚¯ï¼ˆ`active_flag / is_accepting_reservations / is_ready_to_publish`ï¼‰ã¯
  ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ service å±¤ã§å®Œçµã—ã¦ãŠã‚Šã€FarmDetailPage ã‹ã‚‰ V1 ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚„ãƒ•ãƒ©ã‚°ã‚’
  ç›´æ¥å‚ç…§ã™ã‚‹éƒ¨åˆ†ã¯å­˜åœ¨ã—ãªã„ã€‚



4-3. ReservationFormDTO

äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆè¾²å®¶è©³ç´°ãƒšãƒ¼ã‚¸ â†’ äºˆç´„å†…å®¹ç¢ºèªãƒšãƒ¼ã‚¸ï¼‰ã‹ã‚‰ã‚µãƒ¼ãƒãƒ¼ã«é€ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã€‚

ä¾¡æ ¼æƒ…å ±ã¯ä¸€åˆ‡é€ã‚‰ãªã„

ã€Œã©ã®è¾²å®¶ã§ã€ã€Œã©ã®ã‚¹ãƒ­ãƒƒãƒˆã«ã€ã€Œã©ã®ã‚µã‚¤ã‚ºã‚’ä½•å£äºˆç´„ã™ã‚‹ã‹ã€ã ã‘ã‚’æ¸¡ã—ã€
å˜ä¾¡ãƒ»å°è¨ˆã¯ã™ã¹ã¦ã‚µãƒ¼ãƒãƒ¼å´ã§ç¢ºå®šã™ã‚‹

TypeScript å®šç¾©ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆå´ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰

// ConfirmPage ã‹ã‚‰ POST /api/reservations ã«é€ã‚‹ãƒœãƒ‡ã‚£
export type ReservationFormDTO = {
  farm_id: number;

  // äºˆç´„ã™ã‚‹å—ã‘æ¸¡ã—ã‚¹ãƒ­ãƒƒãƒˆ
  // ä¾‹: "WED_19_20"
  pickup_slot_code: string;

  // äºˆç´„ã™ã‚‹ãŠç±³ã®å†…è¨³
  items: {
    size_kg: 5 | 10 | 25; // 5kg / 10kg / 25kg ã®ã©ã‚Œã‹
    quantity: number;     // ãã®ã‚µã‚¤ã‚ºã‚’ä½•å£äºˆç´„ã™ã‚‹ã‹ï¼ˆ1ä»¥ä¸Šã®æ•´æ•°ï¼‰
  }[];
};


èª¬æ˜

farm_id

å¯¾è±¡ã¨ãªã‚‹è¾²å®¶ã®IDã€‚FarmDetailã‹ã‚‰å¼•ãç¶™ãã€‚

pickup_slot_code

å—ã‘æ¸¡ã—ã‚¹ãƒ­ãƒƒãƒˆã‚’è¡¨ã™ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: "WED_19_20"ï¼‰ã€‚

äºˆç´„ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ«ã€Œfarm_id ã¨ pickup_slot_code ã¯å¿…é ˆã€ã‚’æº€ãŸã™ãŸã‚ã€å¿…é ˆé …ç›®ã¨ã™ã‚‹ã€‚

items[]

size_kg â€¦ äºˆç´„ã™ã‚‹æ ã‚µã‚¤ã‚ºï¼ˆ5kg / 10kg / 25kgï¼‰ã€‚

quantity â€¦ ãã®ã‚µã‚¤ã‚ºã‚’ä½•æ äºˆç´„ã™ã‚‹ã‹ï¼ˆ1,2,...ï¼‰ã€‚

å˜ä¾¡ã‚„å°è¨ˆã¯é€ã‚‰ãšã€ã‚µãƒ¼ãƒãƒ¼å´ã§ farms.price_5kg / 10kg / 25kg ã‹ã‚‰è¨ˆç®—ã™ã‚‹ã€‚

4-4. ReservationResultDTO

äºˆç´„ä½œæˆå¾Œã«ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã™ãƒ¬ã‚¹ãƒãƒ³ã‚¹ DTOã€‚

Confirm ãƒšãƒ¼ã‚¸ï¼ˆäºˆç´„å†…å®¹ã®ç¢ºèªï¼‰

äºˆç´„å®Œäº†ãƒšãƒ¼ã‚¸

ã®ä¸¡æ–¹ã§å…±é€šã—ã¦åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’æƒ³å®šã™ã‚‹ã€‚
ç¾åœ¨ã® UI ã§ã¯ Confirm ãƒšãƒ¼ã‚¸ã¯ã€Œé‡‘é¡ç¢ºèªã®ã¿ã€ãªã®ã§ã€
é‡‘é¡é–¢é€£ï¼‹äºˆç´„IDã‚’ä¸­å¿ƒã¨ã—ãŸæœ€å°ã‚»ãƒƒãƒˆã‚’å®šç¾©ã™ã‚‹ã€‚

TypeScript å®šç¾©ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆå´ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰

export type ReservationResultItemDTO = {
  size_kg: 5 | 10 | 25;
  quantity: number;
  unit_price: number;  // ã“ã®ã‚µã‚¤ã‚º1æ ã‚ãŸã‚Šã®é‡‘é¡
  subtotal: number;    // unit_price * quantity
};

export type ReservationResultDTO = {
  // äºˆç´„è­˜åˆ¥å­ï¼ˆStripe ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæ™‚ã«ä½¿ç”¨ï¼‰
  reservation_id: number;

  // ã©ã®è¾²å®¶ã®äºˆç´„ã‹ï¼ˆå®Œäº†ãƒšãƒ¼ã‚¸ãªã©ã§ä½¿ç”¨ï¼‰
  farm_id: number;

  // ãŠç±³ä»£ã®å†…è¨³
  items: ReservationResultItemDTO[];
  rice_subtotal: number;   // items[].subtotal ã®åˆè¨ˆ

  // Stripe ã§æ±ºæ¸ˆã™ã‚‹é‹å–¶ã‚µãƒãƒ¼ãƒˆè²»
  service_fee: number;     // ä¾‹: 300
  currency: "jpy";
};


èª¬æ˜

reservation_id

ä½œæˆã•ã‚ŒãŸäºˆç´„ã®IDã€‚

POST /stripe/checkout/{reservation_id} ã®å…¥åŠ›ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã€‚

farm_id

å¯¾è±¡è¾²å®¶ã®IDã€‚å®Œäº†ãƒšãƒ¼ã‚¸ã‚„å°†æ¥ã®å±¥æ­´ç”»é¢ã§åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ä¿æŒã—ã¦ãŠãã€‚

items[]

size_kg / quantity ã¯ ReservationFormDTO ã¨åŒã˜ã€‚

unit_price ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§ farms ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰æ±ºå®šã—ãŸ 1æ ã‚ãŸã‚Šã®ä¾¡æ ¼ã€‚

subtotal ã¯ unit_price * quantity ã‚’ã‚µãƒ¼ãƒãƒ¼å´ã§è¨ˆç®—ã—ãŸå€¤ã€‚

rice_subtotal

ãŠç±³ä»£ã®åˆè¨ˆé‡‘é¡ã€‚Confirm ãƒšãƒ¼ã‚¸ã®ã€ŒãŠç±³ä»£ï¼ˆç¾åœ°ã§è¾²å®¶ã•ã‚“ã«ãŠæ”¯æ‰•ã„ï¼‰ã€ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹ã€‚

service_fee

Stripe ã§ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ±ºæ¸ˆã™ã‚‹é‡‘é¡ï¼ˆé‹å–¶ã‚µãƒãƒ¼ãƒˆè²»ï¼‰ã€‚

ç¾çŠ¶ã¯ 300 å††ã ãŒã€å°†æ¥ã®ä»•æ§˜å¤‰æ›´ã«å‚™ãˆã¦ã‚µãƒ¼ãƒãƒ¼å´ã§å€¤ã‚’æŒã¤ã€‚

currency

é€šè²¨ã‚³ãƒ¼ãƒ‰ã€‚ç¾çŠ¶ã¯ "jpy" å›ºå®šã€‚

â€» ã€Œåˆè¨ˆï¼ˆãŠç±³ä»£ï¼‹é‹å–¶ã‚µãƒãƒ¼ãƒˆè²»ï¼‰ã€ã¯ UI ã‹ã‚‰åˆè¨ˆã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã™ã‚‹æ–¹é‡ã®ãŸã‚ã€
DTO ã«ã¯ total ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒãŸã›ãªã„ã€‚


Customer Booking Domain V2.md ã®ä¸­ã§ï¼š

4-4. ReservationResultDTO

ï¼ˆå®Œäº†ãƒšãƒ¼ã‚¸ç”¨ã®è¡¨ç¤ºæƒ…å ±ï¼‰



5. API è¨­è¨ˆ


ã¨ãªã£ã¦ã„ã‚‹ã¯ãšãªã®ã§ã€
ã€Œï¼ˆå®Œäº†ãƒšãƒ¼ã‚¸ç”¨ã®è¡¨ç¤ºæƒ…å ±ï¼‰ã€ã®è¡Œã®ã™ãä¸‹ ã«ã€ä¸‹ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ã€‚

Customer Booking Domain V2

è¿½è¨˜ã™ã‚‹å†…å®¹ï¼ˆãã®ã¾ã¾ã‚³ãƒ”ãƒšã§OKï¼‰
4-5. Reservation æ°¸ç¶šåŒ–ï¼ˆreservations ãƒ†ãƒ¼ãƒ–ãƒ«ä»•æ§˜ï¼‰

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€Confirm Page / Stripe æ±ºæ¸ˆã§ä½¿ç”¨ã™ã‚‹äºˆç´„ãƒ¬ã‚³ãƒ¼ãƒ‰
ï¼ˆSQLite ãƒ†ãƒ¼ãƒ–ãƒ« `reservations`ï¼‰ã® V2 ä»•æ§˜ã‚’å®šç¾©ã™ã‚‹ã€‚

### 4-5-1. ç›®çš„

- Confirm Page ã§ä½œæˆã—ãŸäºˆç´„ã‚’ã€Œpending â†’ confirmedã€ã® 2 æ®µéšã§ç®¡ç†ã™ã‚‹ã€‚
- äºˆç´„å†…å®¹ï¼ˆä½•kgã‚’ä½•è¢‹ / ã©ã®ã‚¹ãƒ­ãƒƒãƒˆã‹ï¼‰ã‚’ JSON ã§æ­£ç¢ºã«ä¿å­˜ã™ã‚‹ã€‚
- éå»äºˆç´„ã®é›†è¨ˆãƒ»åˆ†æï¼ˆé›¢è„±ç‡ã€æ±ºæ¸ˆæˆåŠŸç‡ãªã©ï¼‰ã«è€ãˆã‚‰ã‚Œã‚‹æ§‹é€ ã«ã™ã‚‹ã€‚
- æ—¢å­˜ã® V1 ã‚«ãƒ©ãƒ ï¼ˆitem / quantity / price / amount ãªã©ï¼‰ã¯æ®‹ã—ãŸã¾ã¾ã€
  V2 ã§ã¯ **æ–°ã‚«ãƒ©ãƒ ç¾¤ã‚’çœŸå®Ÿã®ã‚½ãƒ¼ã‚¹ã¨ã—ã¦ä½¿ã†**ã€‚

### 4-5-2. reservations ãƒ†ãƒ¼ãƒ–ãƒ« ã‚«ãƒ©ãƒ ä¸€è¦§ï¼ˆV2 ã§é‡è¦ãªã‚‚ã®ï¼‰

ï¼ˆå®Ÿè£…ãƒ¡ãƒ¢ï¼‰

2025-11-23 ã®æ™‚ç‚¹ã§ã€æ—¢å­˜ã® `reservations` ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦

- `item / quantity / price / amount`
- `user_confirmation_status` ãªã© V1 ç”±æ¥ã®ã‚«ãƒ©ãƒ 

ã‚’å«ã‚€ã™ã¹ã¦ã«ã¤ã„ã¦ NOT NULL åˆ¶ç´„ã‚’è§£é™¤ã—ã€`id` ä»¥å¤–ã¯ NULL è¨±å®¹ã¨ã—ãŸã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€V2 ã§ã¯

- INSERT æ™‚ã« `item / quantity / price / amount` ãªã©ã‚’ä¸€åˆ‡ã‚»ãƒƒãƒˆã—ãªã„
- `items_json / rice_subtotal / service_fee / pickup_slot_code / currency` ã‚’ **çœŸå®Ÿã®ã‚½ãƒ¼ã‚¹** ã¨ã—ã¦æ‰±ã†

ã¨ã„ã†é‹ç”¨ã‚’å®‰å…¨ã«è¡Œã†ã€‚


| ã‚«ãƒ©ãƒ å   | å‹              | NULL | ç”¨é€” |
|-----------|-----------------|------|------|
| id        | INTEGER PK      | NO   | äºˆç´„IDï¼ˆReservationResultDTO.reservation_id ã¨ä¸€è‡´ï¼‰ |
| user_id   | INTEGER         | NO   | äºˆç´„ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå½“é¢ã¯ 1 å›ºå®šãªã©ã§é‹ç”¨å¯ï¼‰ |
| farm_id   | INTEGER         | NO   | ã©ã®è¾²å®¶ã¸ã®äºˆç´„ã‹ |

#### å—ã‘æ¸¡ã—ã‚¹ãƒ­ãƒƒãƒˆ

| ã‚«ãƒ©ãƒ å           | å‹             | NULL | ç”¨é€” |
|--------------------|----------------|------|------|
| pickup_slot_code   | VARCHAR(32)    | YES  | å—ã‘æ¸¡ã—æ™‚é–“å¸¯ã‚³ãƒ¼ãƒ‰ã€‚ä¾‹: `"WED_19_20"`ã€‚V2 ã§ã¯å¿…ãšã‚»ãƒƒãƒˆã™ã‚‹ãŒã€æ—¢å­˜äºˆç´„äº’æ›ã®ãŸã‚ DB ä¸Šã¯ NULL è¨±å®¹ã€‚ |

#### äºˆç´„ã‚¢ã‚¤ãƒ†ãƒ å†…è¨³ï¼ˆãŠç±³ï¼‰

| ã‚«ãƒ©ãƒ å    | å‹    | NULL | ç”¨é€” |
|------------|-------|------|------|
| items_json | TEXT  | YES  | äºˆç´„ã—ãŸãŠç±³ã®å†…è¨³ã‚’ JSON é…åˆ—ã§ä¿å­˜ã™ã‚‹ã€‚V2 ã§ã¯ã“ã“ã‚’ **çœŸå®Ÿã®ã‚½ãƒ¼ã‚¹** ã¨ã™ã‚‹ã€‚ |

`items_json` ã®ä¸­èº«ï¼ˆä¾‹ï¼‰:

```json
[
  { "size_kg": 10, "quantity": 2, "unit_price": 8000, "line_total": 16000 },
  { "size_kg": 5,  "quantity": 1, "unit_price": 4200, "line_total": 4200 },
  { "size_kg": 25, "quantity": 1, "unit_price": 18400, "line_total": 18400 }
]


Confirm Page ã‹ã‚‰é€ã‚‰ã‚Œã¦ãã‚‹ã®ã¯ size_kg ã¨ quantity ã®ã¿ã€‚

unit_price / line_total ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§ farms.price_5kg/10kg/25kg ã‹ã‚‰è¨ˆç®—ã—ã¦åŸ‹ã‚ã‚‹ã€‚

é‡‘é¡ï¼ˆãŠç±³ä»£ï¼‹é‹å–¶ã‚µãƒãƒ¼ãƒˆè²»ï¼‰
ã‚«ãƒ©ãƒ å	å‹	NULL	ç”¨é€”
rice_subtotal	INTEGER	YES	items_json ã® line_total åˆè¨ˆï¼ãŠç±³ä»£åˆè¨ˆã€‚Confirm Page ã®ã€ŒãŠç±³ä»£ï¼ˆç¾åœ°ã§è¾²å®¶ã•ã‚“ã«ãŠæ”¯æ‰•ã„ï¼‰ã€è¡¨ç¤ºã®å…ƒãƒ‡ãƒ¼ã‚¿ã€‚
service_fee	INTEGER	YES	é‹å–¶ã‚µãƒãƒ¼ãƒˆè²»ã€‚ç¾åœ¨ã¯å¸¸ã« 300 ã‚’ä¿å­˜ã™ã‚‹ã€‚å°†æ¥å¤‰æ›´ã—ã¦ã‚‚éå»ãƒ¬ã‚³ãƒ¼ãƒ‰ã®é‡‘é¡ãŒå´©ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã€‚
currency	VARCHAR(10)	NO	é€šè²¨ã‚³ãƒ¼ãƒ‰ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ "jpy"ã€‚
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«
ã‚«ãƒ©ãƒ å	å‹	NULL	ç”¨é€”
status	VARCHAR(32)	NO	äºˆç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€‚V2ã§ã¯ "pending" / "confirmed" ã‚’ä½¿ç”¨ã€‚å°†æ¥ "cancelled" ãªã©æ‹¡å¼µå¯ã€‚
created_at	DATETIME	YES	ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆæ™‚åˆ»ã€‚äºˆç´„ãŒ pending ã«ãªã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚° ã¨ã—ã¦æ‰±ã†ã€‚
payment_succeeded_at	DATETIME	YES	Stripe æ±ºæ¸ˆæˆåŠŸæ™‚åˆ»ã€‚V2ã§ã¯äº‹å®Ÿä¸Š confirmed_at ã¨ã—ã¦æ‰±ã†ã€‚

â€» æ—¢å­˜ã‚«ãƒ©ãƒ  status / created_at / payment_succeeded_at ã¯
V2 ã§ã‚‚ãã®ã¾ã¾åˆ©ç”¨ã™ã‚‹ã€‚æ–°ãŸã« confirmed_at ã‚«ãƒ©ãƒ ã¯å¢—ã‚„ã•ãšã€
payment_succeeded_at ã‚’ confirmed ã®æ™‚åˆ»ã¨ã—ã¦æ‰±ã†ã€‚

æ±ºæ¸ˆãƒ»LINEé€šçŸ¥é–¢é€£ï¼ˆæ—¢å­˜ã‚«ãƒ©ãƒ ã‚’ãã®ã¾ã¾åˆ©ç”¨ï¼‰
ã‚«ãƒ©ãƒ å	å‹	NULL	ç”¨é€”
payment_intent_id	VARCHAR(100)	YES	Stripe PaymentIntent IDï¼ˆã¾ãŸã¯ Checkout Session IDï¼‰ã€‚Webhook ã¨ã®ç´ä»˜ã‘ã«åˆ©ç”¨ã€‚
payment_status	VARCHAR(50)	YES	Stripe å´ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆsucceeded ãªã©ï¼‰ã€‚ãƒ‡ãƒãƒƒã‚°ãƒ»éšœå®³è§£æç”¨ã€‚
paid_service_fee	BOOLEAN	NO	V1 ç”±æ¥ã®ãƒ•ãƒ©ã‚°ã€‚V2 ã§ã¯ status == 'confirmed' ã‹ã¤ payment_status == 'succeeded' ã§åŒç­‰ã®æ„å‘³ã‚’æŒã¤ãŸã‚ã€ä¸»ã«äº’æ›ç”¨ã¨ã—ã¦æ®‹ã™ã€‚
line_notified_at	DATETIME	YES	LINE é€šçŸ¥ã‚’é€ã£ãŸæ™‚åˆ»ã€‚å°†æ¥ã®é€šçŸ¥ãƒ­ã‚°/å†é€åˆ¶å¾¡ã«åˆ©ç”¨äºˆå®šã€‚
4-5-3. V1 ã‚«ãƒ©ãƒ ã¨ã®é–¢ä¿‚

V1 ç”±æ¥ã®ä»¥ä¸‹ã®ã‚«ãƒ©ãƒ ã¯ã€éå»ãƒ‡ãƒ¼ã‚¿ã¨ã®äº’æ›æ€§ã®ãŸã‚ã«æ®‹ã™ãŒã€V2 ã§ã¯ãƒ¡ã‚¤ãƒ³ã®æƒ…å ±æºã¨ã—ã¦ã¯ä½¿ã‚ãªã„ã€‚

item / quantity / price / amount

éå»ã®äºˆç´„ã‚µãƒãƒªãƒ¼ã¨ã—ã¦ã¯å‚ç…§å¯èƒ½ã€‚

V2 ã§ã¯ items_json / rice_subtotal / service_fee ã‚’ä½¿ã†å‰æã§è¨­è¨ˆã™ã‚‹ã€‚

4-5-4. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»ï¼ˆpending â†’ confirmedï¼‰

äºˆç´„ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã¯ã‚·ãƒ³ãƒ—ãƒ«ãª 2 æ®µéšã€‚

pending

Confirm Page ã§ã€Œ300å††ã§æ±ºæ¸ˆã«é€²ã‚€ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸç¬é–“ã«ã€
reservations ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ INSERT ã™ã‚‹ã€‚

ã“ã®æ™‚ç‚¹ã§ï¼š

status = 'pending'

created_at = CURRENT_TIMESTAMP

payment_succeeded_at = NULL

Stripe æ±ºæ¸ˆã‚’ã¾ã å®Œäº†ã—ã¦ã„ãªã„ã€Œä»®äºˆç´„ã€ã€‚

confirmed

Stripe Checkout ã§æ±ºæ¸ˆãŒæˆåŠŸã—ã€Webhookï¼ˆ/stripe/webhookï¼‰ãŒ
checkout.session.completed ã‚’å—ä¿¡ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ç¢ºå®šã•ã›ã‚‹ã€‚

ã“ã®ã¨ãï¼š

status = 'confirmed'

payment_status = 'succeeded'ï¼ˆStripe ã®çŠ¶æ…‹ã«åˆã‚ã›ã‚‹ï¼‰

payment_succeeded_at = CURRENT_TIMESTAMP

ã“ã®æ™‚ç‚¹ã§äºˆç´„ã¯æ­£å¼ã«ç¢ºå®šã™ã‚‹ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ Stripe ç”»é¢ã§é›¢è„±ã—ãŸå ´åˆï¼š

status = 'pending' ã®ã¾ã¾æ®‹ã‚Šç¶šã‘ã‚‹ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€æ±ºæ¸ˆé›¢è„±ç‡ã®åˆ†æã‚„éšœå®³æ¤œçŸ¥ï¼ˆWebhook æ­»äº¡ãªã©ï¼‰ãŒå¯èƒ½ã«ãªã‚‹ã€‚

4-5-5. Confirm Page / Stripe ã¨ã®é–¢ä¿‚ï¼ˆã‚µãƒãƒªï¼‰

Confirm Page â†’ POST /api/reservations

ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: ReservationFormDTO

å‡¦ç†å†…å®¹:

reservations ã« status = 'pending' ã§ INSERT

items_json / rice_subtotal / service_fee ã‚’è¨ˆç®—ãƒ»ä¿å­˜

ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ReservationResultDTO

ãƒ•ãƒ­ãƒ³ãƒˆã¯ãã®å¾Œã€reservation_id ã‚’ä½¿ã£ã¦ Stripe Checkout ç”¨ã®
ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ/stripe/checkout/{reservation_id} ãªã©ï¼‰ã‚’å‘¼ã³å‡ºã™ã€‚

Stripe æ±ºæ¸ˆæˆåŠŸ â†’ Webhook /stripe/webhook

Stripe ã® metadata / payment_intent_id ã‹ã‚‰ reservation_id ã‚’ç‰¹å®š

å¯¾å¿œã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦ï¼š

status = 'confirmed'

payment_status = 'succeeded'

payment_succeeded_at = CURRENT_TIMESTAMP

ã“ã‚Œã«ã‚ˆã‚Šã€Œæ±ºæ¸ˆãŒé€šã£ãŸäºˆç´„ã ã‘ãŒ confirmed ã«ãªã‚‹ã€ã“ã¨ã‚’ä¿è¨¼ã™ã‚‹ã€‚


---

ã“ã‚Œã§ã€Œreservations ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã©ã†ä½¿ã†ã‹ã€ã€Œpending / confirmed ã®æ„å‘³ã€ãŒ  
å°†æ¥è¦‹ç›´ã™ã¨ãã«ã‚‚è¿·ã‚ãªã„ãƒ¬ãƒ™ãƒ«ã§è¨­è¨ˆå›³ã«æ®‹ã›ã‚‹ã¯ãšã€‚

æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ã¯ï¼š

- ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ md ã«è²¼ã‚‹  
- DB ã« 5 ã¤ã®ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ï¼ˆpickup_slot_code / items_json / rice_subtotal / service_fee / currencyï¼‰  
- ãã®ã†ãˆã§ `reservations_api.py` ã‚’æ›¸ã„ã¦ã„ã  

ã¨ã„ã†æµã‚Œã§è¡Œã‘ã‚‹ã€‚

5. API è¨­è¨ˆ

GET /api/public/farms?page=1&lat=&lng=

GET /api/public/farms/{farm_id}

5-2. Public Farm Detail APIï¼ˆGET /api/public/farms/{farm_id}ï¼‰

5-2-1. ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ¦‚è¦

HTTP Method: GET

Path: /api/public/farms/{farm_id}

å½¹å‰²:

- è¾²å®¶è©³ç´°ãƒšãƒ¼ã‚¸ï¼ˆ/farms/{farm_id}ï¼‰ã«å¿…è¦ãªæƒ…å ±ã‚’ 1ä»¶åˆ†è¿”ã™
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹æœ¬ä½“ã¯ PublicFarmDetailDTO

å…¬é–‹å¯¾è±¡ï¼ˆãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ï¼‰ã¯ä¸€è¦§ã¨åŒã˜ã Farmer Domain V2 ã®

- farms.active_flag == 1
- farms.is_accepting_reservations == true
- farms.is_ready_to_publish == true

ã‚’ã™ã¹ã¦æº€ãŸã™ farm ã®ã¿ã€‚

5-2-2. ãƒªã‚¯ã‚¨ã‚¹ãƒˆä»•æ§˜

Path Parameter:

- farm_id: intï¼ˆå¿…é ˆï¼‰

ä¾‹:

GET /api/public/farms/63

5-2-3. æ­£å¸¸ç³»ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆ200 OKï¼‰

{
  "ok": true,
  "farm": {
    // PublicFarmDetailDTO
    "farm_id": 63,
    "owner_full_name": "å±±ç”°å¤ªéƒ",
    "owner_label": "å±±ç”°å¤ªéƒã•ã‚“ã®ãŠç±³",
    "owner_address_label": "å¾³å³¶çœŒé˜¿å—å¸‚è¦‹èƒ½æ—ã®è¾²å®¶",

    "price_10kg": 8700,
    "price_5kg": 4600,
    "price_25kg": 21000,

    "face_image_url": "https://.../face.jpg",
    "pr_images": [
      "https://.../pr1.jpg",
      "https://.../pr2.jpg"
    ],
    "pr_title": "æ¸›è¾²è–¬ã‚³ã‚·ãƒ’ã‚«ãƒªã‚’å®¶æ—ã§è‚²ã¦ã¦ã„ã¾ã™",
    "pr_text": "å®¶æ—ã§è‚²ã¦ãŸãŠç±³ã‚’ã€ç²¾ç±³ã—ãŸã¦ã§ãŠå±Šã‘ã—ã¾ã™ã€‚",

    "pickup_slot_code": "WED_19_20",
    "next_pickup_display": "11/27ï¼ˆæ°´ï¼‰19:00â€“20:00",
    "next_pickup_start": "2025-11-27T19:00:00+09:00",
    "next_pickup_deadline": "2025-11-27T16:00:00+09:00",

    "pickup_lat": 34.123456,
    "pickup_lng": 134.56789,
    "center_lat": 34.123456,
    "center_lng": 134.56789,

    "address_text": "å¾³å³¶çœŒé˜¿å—å¸‚è¦‹èƒ½æ—ç”ºâ—¯â—¯-â—¯â—¯",

    "rice_variety_label": "ã‚³ã‚·ãƒ’ã‚«ãƒª",
    "harvest_year": 2025,

    "pickup_time": "11/27ï¼ˆæ°´ï¼‰19:00â€“20:00",

    "good_rate": 97,
    "deals_count": 13,

    "share_url": "https://rice-app.example.com/farms/63"
  }
}

5-2-4. ç•°å¸¸ç³»ãƒ¬ã‚¹ãƒãƒ³ã‚¹

1) å…¬é–‹æ¡ä»¶ã‚’æº€ãŸã•ãªã„ / farm_id ä¸æ­£

- 404 Not Found

{
  "ok": false,
  "error_code": "FARM_NOT_FOUND",
  "message": "æŒ‡å®šã•ã‚ŒãŸè¾²å®¶ã¯è¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ç¾åœ¨ã¯å…¬é–‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
}

2) ãã®ä»–ã®ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼

- 500 Internal Server Error

{
  "ok": false,
  "error_code": "INTERNAL_ERROR",
  "message": "äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
}


POST /api/reservations

POST /stripe/checkout/{reservation_id}

POST /stripe/webhook

5-3. Reservation APIï¼ˆPOST /api/reservationsï¼‰

5-3-1. ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ¦‚è¦

- HTTP Method: POST
- Path: `/api/reservations`
- å½¹å‰²: Confirm Page ã‹ã‚‰ã®å…¥åŠ›ï¼ˆã©ã®è¾²å®¶ã§ / ã©ã®ã‚¹ãƒ­ãƒƒãƒˆã« / ä½•kgã‚’ä½•è¢‹ã‹ï¼‰ã‚’å—ã‘å–ã‚Šã€
  ã‚µãƒ¼ãƒãƒ¼å´ã§å˜ä¾¡ãƒ»å°è¨ˆã‚’ç¢ºå®šã—ãŸã†ãˆã§
  `reservations` ãƒ†ãƒ¼ãƒ–ãƒ«ã« `status = 'pending'` ã®äºˆç´„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹ã€‚

æœ¬ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ V2 å°‚ç”¨ã§ã‚ã‚Šã€V1 ã® `item / quantity / price / amount` ã‚«ãƒ©ãƒ ã«ã¯ä¸€åˆ‡æ›¸ãè¾¼ã¾ãªã„ã€‚

5-3-2. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ï¼ˆReservationFormDTOï¼‰

Content-Type: `application/json`

```json
{
  "farm_id": 71,
  "pickup_slot_code": "WED_19_20",
  "items": [
    { "size_kg": 5, "quantity": 1 },
    { "size_kg": 10, "quantity": 1 },
    { "size_kg": 25, "quantity": 1 }
  ]
}

farm_id: äºˆç´„å¯¾è±¡ã®è¾²å®¶ IDï¼ˆå¿…é ˆï¼‰

pickup_slot_code: å—ã‘æ¸¡ã—ã‚¹ãƒ­ãƒƒãƒˆã‚³ãƒ¼ãƒ‰ï¼ˆå¿…é ˆï¼‰ã€‚ä¾‹: "WED_19_20"

items[]: äºˆç´„ã™ã‚‹ãŠç±³ã®å†…è¨³

size_kg: 5 / 10 / 25 ã®ã„ãšã‚Œã‹ï¼ˆ5kg / 10kg / 25kg æ ï¼‰

quantity: 1 ä»¥ä¸Šã®æ•´æ•°

å˜ä¾¡ãƒ»åˆè¨ˆé‡‘é¡ã¯ä¸€åˆ‡é€ã‚‰ãªã„ã€‚
ã‚µãƒ¼ãƒãƒ¼å´ã§ farms.price_5kg / price_10kg / price_25kg ã‹ã‚‰ç¢ºå®šã™ã‚‹ã€‚

ã€è¿½åŠ ä»•æ§˜ï¼šConfirm Page ã®æœ‰åŠ¹æœŸé™ï¼ˆclient_next_pickup_deadline_isoï¼‰ã€‘

Confirm Page ã‚’é–‹ã„ãŸã¨ãã®ç· åˆ‡ï¼ˆnext_pickup_deadlineï¼‰ã‚’
ãƒ•ãƒ­ãƒ³ãƒˆå´ã§ client_next_pickup_deadline_iso ã¨ã—ã¦ä¿å­˜ã—ã€
äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆ POST /api/reservations ã® body ã«å«ã‚ã¦é€ä¿¡ã™ã‚‹ã€‚

ã‚µãƒ¼ãƒãƒ¼å´ã§ã¯ï¼š

1. client_next_pickup_deadline_iso ãŒ pastï¼ˆnow >= deadlineï¼‰ãªã‚‰ â†’ 409 ã‚’è¿”ã™
2. æœªæ¥ã®æ™‚åˆ»ãªã‚‰ â†’ é€šå¸¸ã©ãŠã‚Š pending äºˆç´„ã‚’ä½œæˆ

ã“ã‚Œã«ã‚ˆã‚Šï¼š

- UI ã‚’é–‹ãã£ã±ãªã—ã®ã¾ã¾ç· åˆ‡ã‚’è·¨ãã¨ 409
- UI / Detail / Confirm / API é–“ã®ç· åˆ‡ãƒ­ã‚¸ãƒƒã‚¯ãŒ100%ä¸€è‡´
- æ”¹ã–ã‚“ã•ã‚ŒãŸ deadlineï¼ˆéå»å€¤ï¼‰ã‚‚ç¢ºå®Ÿã«æ‹’å¦ã•ã‚Œã‚‹

ã¨ã„ã†å®Œå…¨ãªä¸€è²«æ€§ãŒä¿è¨¼ã•ã‚Œã‚‹ã€‚


5-3-3. ã‚µãƒ¼ãƒãƒ¼å´ã®å‡¦ç†å†…å®¹ï¼ˆæ¦‚è¦ï¼‰

items ãŒç©ºã®å ´åˆã¯ 400 ã‚’è¿”ã™ã€‚

å„ items[i] ã«ã¤ã„ã¦:

quantity <= 0 ã®å ´åˆã¯ 400ã€‚

size_kg ã«å¿œã˜ã¦ farms ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å˜ä¾¡ (price_5kg / price_10kg / price_25kg) ã‚’å–å¾—ã€‚

unit_price * quantity ã‚’è¨ˆç®—ã—ã€å°è¨ˆ subtotal ã‚’æ±‚ã‚ã‚‹ã€‚

ã™ã¹ã¦ã® subtotal ã‚’åˆè¨ˆã—ã¦ rice_subtotal ã‚’ç®—å‡ºã€‚

é‹å–¶ã‚µãƒãƒ¼ãƒˆè²» service_fee ã¯ç¾çŠ¶ 300 å††ã§å›ºå®šï¼ˆå°†æ¥å¤‰æ›´ã«å‚™ãˆã¦ã‚µãƒ¼ãƒãƒ¼å´ã§ä¿æŒï¼‰ã€‚

items_json ã«ä»¥ä¸‹ã® JSON é…åˆ—ã‚’ä¿å­˜ã™ã‚‹:

[
  { "size_kg": 5,  "quantity": 1, "unit_price": 3685,  "subtotal": 3685 },
  { "size_kg": 10, "quantity": 1, "unit_price": 7700,  "subtotal": 7700 },
  { "size_kg": 25, "quantity": 1, "unit_price": 15410, "subtotal": 15410 }
]

reservations ãƒ†ãƒ¼ãƒ–ãƒ«ã« INSERT ã™ã‚‹:

user_id: å½“é¢ã¯ 1 å›ºå®šï¼ˆå°†æ¥çš„ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ç´ä»˜ã‘ï¼‰

farm_id: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã® farm_id

pickup_slot_code: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã® pickup_slot_code

items_json: ä¸Šè¨˜ JSON æ–‡å­—åˆ—

rice_subtotal: è¨ˆç®—ã•ã‚ŒãŸåˆè¨ˆ

service_fee: 300

currency: "jpy"

status: "pending"

created_at: CURRENT_TIMESTAMP

V1 ç”±æ¥ã® item / quantity / price / amount ãªã©ã®ã‚«ãƒ©ãƒ ã¯ NULL ã®ã¾ã¾ã«ã™ã‚‹ã€‚

5-3-4. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ï¼ˆReservationResultDTOï¼‰

æˆåŠŸæ™‚ï¼ˆ200 OKï¼‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:

{
  "reservation_id": 169,
  "farm_id": 71,
  "items": [
    {
      "size_kg": 5,
      "quantity": 1,
      "unit_price": 3685,
      "subtotal": 3685
    },
    {
      "size_kg": 10,
      "quantity": 1,
      "unit_price": 7700,
      "subtotal": 7700
    },
    {
      "size_kg": 25,
      "quantity": 1,
      "unit_price": 15410,
      "subtotal": 15410
    }
  ],
  "rice_subtotal": 26795,
  "service_fee": 300,
  "currency": "jpy"
}


reservation_id: ä½œæˆã•ã‚ŒãŸäºˆç´„ã® IDï¼ˆreservations.idï¼‰

farm_id: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨åŒã˜

items[]: ã‚µãƒ¼ãƒãƒ¼å´ã§ç¢ºå®šã—ãŸå˜ä¾¡ã¨å°è¨ˆ

rice_subtotal: items[].subtotal ã®åˆè¨ˆ

service_fee: Stripe ã§æ±ºæ¸ˆã™ã‚‹é‹å–¶ã‚µãƒãƒ¼ãƒˆè²»

currency: "jpy"

Confirm Page ã§ã¯ã€ã“ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãã®ã¾ã¾

ã€ŒãŠç±³ä»£ï¼ˆç¾åœ°æ‰•ã„ï¼‰ã€ = rice_subtotal

ã€Œé‹å–¶ã‚µãƒãƒ¼ãƒˆè²»ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ±ºæ¸ˆï¼‰ã€ = service_fee

ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹ã€‚
åˆè¨ˆã‚«ãƒ¼ãƒ‰ã¯ UI ã®æ–¹é‡ã©ãŠã‚Š è¡¨ç¤ºã—ãªã„ ãŸã‚ã€DTO ã« total ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å­˜åœ¨ã—ãªã„ã€‚

5-3-5. ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹

400 Bad Request

items ãŒç©º

quantity <= 0

size_kg ãŒ 5 / 10 / 25 ä»¥å¤–

farm_id ã«å¯¾å¿œã™ã‚‹ farms ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªã„

æŒ‡å®šã‚µã‚¤ã‚ºã®ä¾¡æ ¼ (price_5kg ãªã©) ãŒæœªè¨­å®šã®å ´åˆ

500 Internal Server Error

ãã®ä»–ã®äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼


---

ã“ã® 3ç‚¹ã ã‘å…¥ã‚Œã¦ãŠã‘ã°ã€

- ã€ŒV1äº’æ›ã‚’æ°—ã«ã—ãªã„ã€ã¨ã„ã†æ–¹é‡
- `reservations` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã©ã†å¤‰ãˆãŸã‹
- `/api/reservations` ãŒä½•ã‚’ã—ã¦ã„ã‚‹ã‹

ãŒè¨­è¨ˆæ›¸ã¨å®Ÿè£…ã§å®Œå…¨ã«æƒã„ã¾ã™ã€‚

ã“ã‚Œä»¥ä¸Šã¯ã€Stripe ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãƒ»Webhook ã®å…·ä½“ä»•æ§˜ã¯ã¾ã ã“ã‚Œã‹ã‚‰ãªã®ã§ã€  
å®Ÿè£…ãŒå›ºã¾ã£ã¦ã‹ã‚‰ 5-4 / 5-5 ã¨ã—ã¦è¿½è¨˜ã™ã‚‹å½¢ã§ååˆ†ã ã¨æ€ã„ã¾ã™ã€‚

6. å…¬é–‹æ¡ä»¶

Farmer Domain V2 ã®

active_flag

is_accepting_reservations

is_ready_to_publish
ã‚’ANDã—ãŸã‚‚ã®ãŒå…¬é–‹æ¡ä»¶ã€‚

7. äºˆç´„ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ«

å—ã‘æ¸¡ã—ç· åˆ‡ï¼ˆnext_pickup_deadlineï¼‰ã‚’éããŸäºˆç´„ã¯å—ã‘ä»˜ã‘ãªã„ã€‚
ãŸã ã—ãƒ•ãƒ­ãƒ³ãƒˆå´ã® Confirm Page ã§ç· åˆ‡å‰ã«ç”»é¢ã‚’é–‹ã„ã¦ã„ãŸå ´åˆã¯ã€
Confirm è¡¨ç¤ºæ™‚ç‚¹ã§ã®ç· åˆ‡ï¼ˆclient_next_pickup_deadline_isoï¼‰ã‚’ãã®ã¾ã¾ä½¿ç”¨ã™ã‚‹ã€‚

ãã®çµæœï¼š

- Confirm â†’ æ±ºæ¸ˆã‚’ç· åˆ‡å‰ã«é–‹å§‹ã—ãŸå ´åˆ â†’ æˆåŠŸ
- Confirm ã‚’é–‹ã„ãŸã¾ã¾ç· åˆ‡ã‚’è·¨ã„ã å ´åˆ â†’ API ãŒ 409 ã‚’è¿”ã—ã¦æ‹’å¦
- UI ã¨ API ã¯ compute_next_pickup ã«ã‚ˆã£ã¦å®Œå…¨ã«ä¸€è‡´ã—ãŸç· åˆ‡ãƒ­ã‚¸ãƒƒã‚¯ã§å‹•ä½œã™ã‚‹


farm_id ã¨ pickup_slot_code ã¯å¿…é ˆ

äºŒé‡äºˆç´„é˜²æ­¢ã¯ V2.1 ä»¥é™ã«æ‹¡å¼µäºˆå®š

8. V1 â†’ V2 ç§»è¡Œæ–¹é‡ï¼ˆ2025-11-24 æ™‚ç‚¹ï¼‰

- ã‚µãƒ¼ãƒãƒ¼å´ã® app_v1 ãƒ•ã‚©ãƒ«ãƒ€ã¯å‰Šé™¤æ¸ˆã¿ã§ã‚ã‚Šã€Public Farm List / Public Farm Detail /
  äºˆç´„ä½œæˆï¼ˆ/api/reservationsï¼‰/ LINE é€£æº / Stripe Checkout & Webhook ã‚’å«ã‚€
  ã™ã¹ã¦ã®ãƒ•ãƒ­ãƒ¼ã¯ app_v2 é…ä¸‹ã®ã¿ã§å‹•ä½œã—ã¦ã„ã‚‹ã€‚
- reservations ãƒ†ãƒ¼ãƒ–ãƒ«ã® V1 ç”±æ¥ã‚«ãƒ©ãƒ ï¼ˆitem / quantity / price / amount ãªã©ï¼‰ã¯
  éå»ãƒ‡ãƒ¼ã‚¿é–²è¦§ç”¨ã¨ã—ã¦æ®‹ã™ãŒã€æ–°è¦ã®æ›¸ãè¾¼ã¿ãƒ»èª­ã¿å–ã‚Šãƒ­ã‚¸ãƒƒã‚¯ã¯
  items_json / rice_subtotal / service_fee / pickup_slot_code / currency ãªã©
  V2 ã‚«ãƒ©ãƒ ç¾¤ã®ã¿ã‚’çœŸå®Ÿã®ã‚½ãƒ¼ã‚¹ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã€‚
- LINE é€£æºã¯ app_v2/integrations/line/line_api.py ãŒæä¾›ã™ã‚‹
  /api/line/login, /api/line/callback, /api/line/linked ãªã©ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’
  å”¯ä¸€ã®å…¥ã‚Šå£ã¨ã—ã€V1 ã® line_auth.py ç³»ã‚³ãƒ¼ãƒ‰ã¯å­˜åœ¨ã—ãªã„ã€‚
- Stripe é€£æºã¯ app_v2/integrations/payments é…ä¸‹ã®
  /stripe/checkout/{reservation_id}ï¼ˆCheckout ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼‰ã¨
  /stripe/webhookï¼ˆæ±ºæ¸ˆçµæœå—ä¿¡ï¼‰ã‚’å”¯ä¸€ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨ã™ã‚‹ã€‚
  V1 ã® create-intent ã‚„ force-confirm ã¯ãƒ†ã‚¹ãƒˆç”¨é€”ã«é™å®šã—ã€
  æœ¬ç•ªãƒ•ãƒ­ãƒ¼ã®ä»•æ§˜ã‹ã‚‰ã¯é™¤å¤–ã™ã‚‹ã€‚
- ä»Šå¾Œè¿½åŠ ã™ã‚‹ Export v2 ã‚„ Admin Dashboardã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘å±¥æ­´ç”»é¢ãªã©ã‚‚ã€
  æœ¬ãƒ‰ãƒ¡ã‚¤ãƒ³ã§å®šç¾©ã—ãŸ V2 DTO / API / ãƒ†ãƒ¼ãƒ–ãƒ«ä»•æ§˜ã®ã¿ã‚’å‰æã«è¨­è¨ˆã™ã‚‹ã€‚


9. ä»Šå¾Œã®æ‹¡å¼µ


LINEé€šçŸ¥

Export v2

Admin Dashboard

5-1. PublicFarmList APIï¼ˆGET /api/public/farmsï¼‰
5-1-1. ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ¦‚è¦

HTTP Method: GET

Path: /api/public/farms

å½¹å‰²:

é¡§å®¢å‘ã‘ã€Œè¾²å®¶ä¸€è¦§ãƒšãƒ¼ã‚¸ï¼‹åœ°å›³ãƒ¢ãƒ¼ãƒ€ãƒ«ã€ã«å¿…è¦ãªãƒªã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™

è¿”å´å˜ä½ã¯ PublicFarmCardDTOï¼ˆä¸€è¦§ã‚«ãƒ¼ãƒ‰ãƒ»åœ°å›³ãƒ”ãƒ³ãƒ»åœ°å›³ä¸‹éƒ¨ã‚·ãƒ¼ãƒˆã§å…±é€šåˆ©ç”¨ï¼‰

8ä»¶ãšã¤ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã—ã€è·é›¢é †ã§ã‚½ãƒ¼ãƒˆã—ã¦è¿”ã™

5-1-2. å…¬é–‹å¯¾è±¡ï¼ˆãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ï¼‰

Farmer Domain V2 ã®å…¬é–‹æ¡ä»¶ã‚’ãã®ã¾ã¾ä½¿ç”¨ã™ã‚‹ï¼š

farms.active_flag == 1ï¼ˆBANã•ã‚Œã¦ã„ãªã„ï¼‰

farms.is_accepting_reservations == trueï¼ˆäºˆç´„å—ä»˜ä¸­ï¼‰

farms.is_ready_to_publish == trueï¼ˆè¨­å®šæƒ…å ±ãŒå…¬é–‹æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ï¼‰

ã“ã‚Œã‚‰ 3æ¡ä»¶ã™ã¹ã¦ã‚’æº€ãŸã™ farm ã®ã¿ ä¸€è¦§ã«è¼‰ã‚‹ã€‚

5-1-3. ãƒªã‚¯ã‚¨ã‚¹ãƒˆä»•æ§˜
ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
GET /api/public/farms?page=1&lat=34.06&lng=134.55

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿	å‹	å¿…é ˆ	èª¬æ˜
page	int	ä»»æ„	1 å§‹ã¾ã‚Šã®ãƒšãƒ¼ã‚¸ç•ªå·ã€‚çœç•¥æ™‚ã¯ 1ã€‚å¸¸ã« 1 ä»¥ä¸Šã€‚
lat	float	ä»»æ„	ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½ç½®ï¼ˆç·¯åº¦ï¼‰ã€‚ä½ç½®ãŒã‚ã‹ã£ã¦ã„ã‚‹å ´åˆã®ã¿é€ã‚‹ã€‚
lng	float	ä»»æ„	ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½ç½®ï¼ˆçµŒåº¦ï¼‰ã€‚ä½ç½®ãŒã‚ã‹ã£ã¦ã„ã‚‹å ´åˆã®ã¿é€ã‚‹ã€‚
page / page_size ã®æ‰±ã„

ãƒ•ãƒ­ãƒ³ãƒˆå®Ÿè£…ä¸Šã€1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Š 8ä»¶å›ºå®š ã§é‹ç”¨ã™ã‚‹ã€‚

API å†…éƒ¨ã§ã¯ page_size = 8 ã‚’å›ºå®šå€¤ã¨ã—ã¦æ‰±ã†ã€‚

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ JSON ã«ã¯ page_size ã‚’å«ã‚ã‚‹ï¼ˆç¢ºèªç”¨ï¼‰ã€‚

ä½ç½®æƒ…å ±ãŒç„¡ã„å ´åˆã®æ‰±ã„ï¼ˆlat / lng çœç•¥æ™‚ï¼‰

lat / lng ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€ã‚µãƒ¼ãƒãƒ¼å´ã§ è¿‘ä¼¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½ç½® ã‚’æ¨å®šã—ã¦ä½¿ã†æƒ³å®šï¼ˆå®Ÿè£…æ–¹æ³•ã¯ã‚¤ãƒ³ãƒ•ãƒ©å´ã§èª¿æ•´ï¼‰

ç¬¬ä¸€å€™è£œ: IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ã®åœ°åŸŸæ¨å®š

ãã‚Œã‚‚ä¸æ˜ãªå ´åˆ: å¾³å³¶çœŒä¸­å¿ƒåº§æ¨™ ã‚’ä½¿ç”¨ï¼ˆä¾‹: lat=34.0703, lng=134.5548ï¼‰

â€» API ä»•æ§˜ã¨ã—ã¦ã¯ã€Œlat/lng æœªæŒ‡å®šã§ã‚‚å‘¼ã³å‡ºã›ã‚‹ã€ã€Œãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒ reasonable ãªä¸­å¿ƒåº§æ¨™ã‚’æ±ºã‚ã‚‹ã€ã¨ã„ã†å‰æã€‚

5-1-4. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä»•æ§˜
æ­£å¸¸ç³»ï¼ˆ200 OKï¼‰
{
  "ok": true,
  "page": 1,
  "page_size": 8,
  "total_count": 42,
  "has_next": true,
  "no_farms_within_100km": false,
  "farms": [
    {
      "farm_id": 63,
      "owner_label": "å±±ç”°å¤ªéƒã•ã‚“ã®ãŠç±³",
      "owner_address_label": "å¾³å³¶çœŒé˜¿å—å¸‚è¦‹èƒ½æ—ã®è¾²å®¶",
      "owner_full_name": "å±±ç”°å¤ªéƒ",
      "price_10kg": 8700,
      "face_image_url": "https://.../face.jpg",
      "pr_images": [
        "https://.../pr1.jpg",
        "https://.../pr2.jpg",
        "https://.../pr3.jpg"
      ],
      "pr_title": "æ¸›è¾²è–¬ã‚³ã‚·ãƒ’ã‚«ãƒªã‚’å®¶æ—ã§è‚²ã¦ã¦ã„ã¾ã™",
      "pickup_slot_code": "WED_19_20",
      "next_pickup_display": "11/27ï¼ˆæ°´ï¼‰19:00â€“20:00",
      "next_pickup_start": "2025-11-27T19:00:00+09:00",
      "next_pickup_deadline": "2025-11-27T16:00:00+09:00",
      "pickup_lat": 34.123456,
      "pickup_lng": 134.56789
    }
  ]
}

ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å	å‹	èª¬æ˜
ok	boolean	å¸¸ã« trueï¼ˆæ­£å¸¸ç³»ï¼‰
page	int	ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ç•ªå·
page_size	int	1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šä»¶æ•°ï¼ˆå¸¸ã« 8ï¼‰
total_count	int	æ¡ä»¶ã«åˆè‡´ã™ã‚‹è¾²å®¶ã®ç·ä»¶æ•°ï¼ˆå…¨ãƒšãƒ¼ã‚¸åˆ†ï¼‰
has_next	boolean	æ¬¡ãƒšãƒ¼ã‚¸ãŒå­˜åœ¨ã™ã‚‹ã‹ã©ã†ã‹
no_farms_within_100km	boolean	100km åœå†…ã«1ä»¶ã‚‚è¾²å®¶ãŒãªã„å ´åˆ true
farms	array	PublicFarmCardDTO ã®é…åˆ—ï¼ˆ0ä»¶ä»¥ä¸Šï¼‰
farms é…åˆ—è¦ç´ ï¼šPublicFarmCardDTO
export type PublicFarmCardDTO = {
  farm_id: number;

  // è¡¨ç¤ºãƒ©ãƒ™ãƒ«ï¼ˆç›´æ„Ÿçš„ & æ„å‘³ãƒ™ãƒ¼ã‚¹ï¼‰
  owner_label: string;          // "å±±ç”°å¤ªéƒã•ã‚“ã®ãŠç±³"
  owner_address_label: string;  // "å¾³å³¶çœŒé˜¿å—å¸‚è¦‹èƒ½æ—ã®è¾²å®¶"
  owner_full_name: string;      // "å±±ç”°å¤ªéƒ"

  price_10kg: number;

  face_image_url: string;
  pr_images: string[];
  pr_title: string;             // PRã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå¿…é ˆé‹ç”¨ï¼‰

  pickup_slot_code: string;     // ä¾‹: "WED_19_20"

  next_pickup_display: string;  // ä¾‹: "11/27ï¼ˆæ°´ï¼‰19:00â€“20:00"
  next_pickup_start: string;    // ISOæ—¥æ™‚: "2025-11-27T19:00:00+09:00"
  next_pickup_deadline: string; // ISOæ—¥æ™‚: "2025-11-27T16:00:00+09:00"

  pickup_lat: number;
  pickup_lng: number;
};


next_pickup_start / next_pickup_deadline ã¯ JST(+09:00) ã® ISO8601 æ–‡å­—åˆ— ã§è¿”ã™ï¼ˆDBã¯UTCã§ã‚‚ã‚ˆã„ãŒ API ãƒ¬ã‚¤ãƒ¤ã§å¤‰æ›ï¼‰ã€‚
ã“ã‚Œã‚‰ next_pickup_* ã¯ã€ã™ã¹ã¦ pickup_time_utils.compute_next_pickup()
ã«ã‚ˆã£ã¦ä¸€å…ƒçš„ã«ç®—å‡ºã•ã‚Œã€Reservation API ã‚‚åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‚ç…§ã™ã‚‹ã€‚


pr_images[0] : ä¸€è¦§ã‚«ãƒ¼ãƒ‰ãƒ»åœ°å›³ãƒ¢ãƒ¼ãƒ€ãƒ«å·¦å´ãƒ¡ã‚¤ãƒ³ç”»åƒã¨ã—ã¦ä½¿ç”¨ã€‚

face_image_url : ä¸€è¦§ã‚«ãƒ¼ãƒ‰ã®ä¸¸ã‚¢ã‚¤ã‚³ãƒ³ã¨ã—ã¦ä½¿ç”¨ã€‚

5-1-5. ä¸¦ã³é †ãƒ»è·é›¢ãƒ­ã‚¸ãƒƒã‚¯
1. è·é›¢ã®åŸºæº–ç‚¹ï¼ˆcenterï¼‰

lat / lng ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ:
â†’ ãã‚Œã‚’ä¸­å¿ƒã¨ã—ã¦è¨ˆç®—ã€‚

æŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆ:
â†’ ã‚µãƒ¼ãƒãƒ¼ãŒæ±ºã‚ãŸã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼è¿‘å‚åº§æ¨™ã€ã¾ãŸã¯ã€Œå¾³å³¶ä¸­å¿ƒã€ã‚’ä½¿ç”¨ï¼ˆä»•æ§˜ 5-1-3 å‚ç…§ï¼‰ã€‚

2. è·é›¢è¨ˆç®—æ–¹æ³•

Haversine æ–¹å¼ ã§ pickup_lat / pickup_lng ã¨ä¸­å¿ƒåº§æ¨™ã®è·é›¢ã‚’è¨ˆç®—ã€‚

è¨ˆç®—ã•ã‚ŒãŸè·é›¢ã‚’å…ƒã« æ˜‡é †ï¼ˆè¿‘ã„é †ï¼‰ã«ã‚½ãƒ¼ãƒˆ ã—ã¦ã‹ã‚‰ã€ãƒšãƒ¼ã‚¸ãƒ³ã‚°ã—ã¦è¿”ã™ã€‚

3. 100km ãƒ•ãƒ©ã‚°ã®åˆ¤å®š

å…¨ä»¶ã®ã†ã¡ã€ä¸­å¿ƒã‹ã‚‰100kmä»¥å†…ã® farm ãŒ1ä»¶ã‚‚ãªã„å ´åˆ
â†’ no_farms_within_100km = true

ãã‚Œã§ã‚‚ distance ã®è¿‘ã„é †ã§ä¸€è¦§ã‚’è¿”ã™

ãƒ•ãƒ­ãƒ³ãƒˆå´ã¯ã“ã®ãƒ•ãƒ©ã‚°ã‚’è¦‹ã¦
ã€Œè¿‘ãã«è¾²å®¶ãŒã„ã¾ã›ã‚“ã€‚ã‹ã‚ã‚Šã«ä¸€ç•ªè¿‘ã„è¾²å®¶ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚ã€
ãªã©ã®æ–‡è¨€ã‚’å‡ºã™ã€‚

â€» 100km ã¯ã€Œãƒ•ã‚£ãƒ«ã‚¿ã€ã§ã¯ãªãã€ŒUIç”¨ã®ãƒ•ãƒ©ã‚°ã€ã§ã‚ã‚Šã€
ã€€å®Ÿéš›ã«ã¯è·é›¢ãŒä½•kmã§ã‚‚ã‚½ãƒ¼ãƒˆã—ã¦è¿”ã™ã€‚

5-1-6. ç•°å¸¸ç³»ãƒ¬ã‚¹ãƒãƒ³ã‚¹
400 Bad Requestï¼ˆä¾‹ï¼‰
{
  "ok": false,
  "error_code": "INVALID_COORDINATES",
  "message": "lat/lng ãŒä¸æ­£ã§ã™"
}


ç™ºç”Ÿæ¡ä»¶ï¼ˆä¾‹ï¼‰ï¼š

lat / lng ã«æ•°å€¤ä»¥å¤–ã®å€¤ãŒå…¥ã£ã¦ã„ã‚‹

ç·¯åº¦ãŒ [-90, 90] ã®ç¯„å›²å¤–

çµŒåº¦ãŒ [-180, 180] ã®ç¯„å›²å¤–

500 Internal Server Errorï¼ˆä¾‹ï¼‰
{
  "ok": false,
  "error_code": "INTERNAL_ERROR",
  "message": "äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
}


ã“ã®ä»•æ§˜ã§ /api/public/farms ã‚’å®Ÿè£…ã—ã¦ãŠã‘ã°ï¼š

FarmsListPage ã¯ farms é…åˆ—ã‚’ãã®ã¾ã¾ã‚«ãƒ¼ãƒ‰ã«ä½¿ãˆã‚‹

MapLayerPortal ã¯ farms ã¨ no_farms_within_100km ã‚’ãã®ã¾ã¾ props ã§ã‚‚ã‚‰ãˆã°ã„ã„

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å…¬é–‹æ¡ä»¶ãƒ»è·é›¢ãƒ­ã‚¸ãƒƒã‚¯ã¯ã™ã¹ã¦ API å´ã§å®Œçµ

ã¨ã„ã†å½¢ã«ãªã‚Šã¾ã™ã€‚


(è¿½è¨˜ï¼‰)
Customer Booking Domain V2 ã¯ ä¸€è¦§ â†’ API â†’ DTO â†’ åœ°å›³ â†’ è©³ç´°ãƒšãƒ¼ã‚¸
ã®é †ã§è¨­è¨ˆãƒ»å®Ÿè£…ã™ã‚‹ã®ãŒã‚‚ã£ã¨ã‚‚ç­‹ãŒé€šã£ã¦ã„ã¦å£Šã‚Œãªã„ã¨æ€ã†ã€‚

âœ… ä»Šå¾Œã®æ­£ã—ã„é€²ã‚æ–¹ï¼ˆå£Šã•ãšãƒ»æœ€çŸ­ï¼‰

æ¬¡ã¯ã“ã®é †ç•ªã§ã‚„ã‚‹ã®ãŒãƒ™ã‚¹ãƒˆï¼š

â‘  PublicFarmCardDTOï¼ˆä¸€è¦§ã‚«ãƒ¼ãƒ‰ç”¨ï¼‰ã‚’100%ç¢ºå®š

ã“ã®éƒ¨åˆ†ã¯ã‚‚ã†ã»ã¼å®Œæˆã—ã¦ã„ã‚‹ã€‚
æœ€å¾Œã«ä¸€åº¦ã ã‘ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ»å‹ãƒ»èª¬æ˜ã‚’ç²¾æŸ»ã—ã¦å®Œå…¨ã« fix ã™ã‚‹ã€‚

â‘¡ Backend å´ã§ PublicFarmCardDTO ã‚’è¿”ã™ API ã‚’ä½œã‚‹

ä¾‹ï¼š
GET /api/public/farms?page=1&per_page=8&lat=...&lng=...

è·é›¢é †ã‚½ãƒ¼ãƒˆ

next_pickup ã®è¨ˆç®—

owner_label / owner_address_label ã®ç”Ÿæˆ

pr_images[0], price_10kg ãªã©

ã“ã® API ãŒå®Œæˆã—ã¦ã‹ã‚‰ UI æ”¹ä¿®ã‚’ã™ã‚‹ã€‚

â‘¢ FarmsListPage.tsx ã« DTO ã‚’ãã®ã¾ã¾æ¸¡ã™

ä¸€è¦§ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤ºã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãŒæƒã†ã€‚

â‘£ åœ°å›³ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆMapLayerPortal.tsxï¼‰ã¸ props ã‚’æ¸¡ã™

ã“ã“ã§åˆã‚ã¦ï¼š

<MapLayerPortal
    open={mapOpen}
    onRequestClose={...}
    farms={publicFarms}
    mapCenter={userApproxLocation}
    noFarmsWithin100km={flag}
/>


ã¨ãªã‚Šã€ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ä¸è¦ãƒ»é•å’Œæ„Ÿã‚¼ãƒ­ã§å‹•ãã€‚

â‘¤ ãã—ã¦æœ€å¾Œã« MapLayerPortal.tsx ã‚’ V2 ä»•æ§˜ã§æ›¸ãæ›ãˆ

ã“ã®æ®µéšãªã‚‰ props ãŒã™ã¹ã¦æƒã£ã¦ã„ã‚‹ã®ã§å£Šã‚Œãªã„ã€‚

âœ… PublicFarmCardDTOï¼ˆæœ€çµ‚ç‰ˆï¼‰
export type PublicFarmCardDTO = {
  farm_id: number;

  // è¡¨ç¤ºãƒ©ãƒ™ãƒ«ï¼ˆç›´æ„Ÿçš„ & æ„å‘³ãƒ™ãƒ¼ã‚¹ï¼‰
  owner_label: string;          // "å±±ç”°å¤ªéƒã•ã‚“ã®ãŠç±³"
  owner_address_label: string;  // "å¾³å³¶çœŒé˜¿å—å¸‚è¦‹èƒ½æ—ã®è¾²å®¶"
  owner_full_name: string;      // "å±±ç”°å¤ªéƒ"

  price_10kg: number;

  face_image_url: string;
  pr_images: string[];
  pr_title: string;             // PRã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå¿…é ˆï¼‰

  pickup_slot_code: string;

  next_pickup_display: string;
  next_pickup_start: string;
  next_pickup_deadline: string;

  pickup_lat: number;
  pickup_lng: number;
};



JSON å‡ºåŠ›ä¾‹ï¼ˆAPI ã®æ­£å¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰

{
  "ok": true,
  "page": 1,
  "page_size": 8,
  "total_count": 42,
  "has_next": true,
  "farms": [
    {
      "farm_id": 63,
      "owner_label": "å±±ç”°å¤ªéƒã•ã‚“ã®ãŠç±³",
      "owner_address_label": "å¾³å³¶çœŒé˜¿å—å¸‚è¦‹èƒ½æ—ã®è¾²å®¶",
      "owner_full_name": "å±±ç”°å¤ªéƒ",
      "price_10kg": 8700,
      "face_image_url": "https://.../face.jpg",
      "pr_images": [
        "https://.../pr1.jpg",
        "https://.../pr2.jpg",
        "https://.../pr3.jpg"
      ],
      "pr_title": "æ¸›è¾²è–¬ã‚³ã‚·ãƒ’ã‚«ãƒªã‚’å®¶æ—ã§è‚²ã¦ã¦ã„ã¾ã™",
      "pickup_slot_code": "WED_19_20",
      "next_pickup_display": "11/27ï¼ˆæ°´ï¼‰19:00â€“20:00",
      "next_pickup_start": "2025-11-27T19:00:00+09:00",
      "next_pickup_deadline": "2025-11-27T16:00:00+09:00",
      "pickup_lat": 34.123456,
      "pickup_lng": 134.56789
    }
  ]
}


10. Public Farm List å®Ÿè£…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆ2025-11-22 æ™‚ç‚¹ï¼‰

ã“ã®ç¯€ã§ã¯ã€Public Farm List / åœ°å›³ãƒ¢ãƒ¼ãƒ€ãƒ«å‘¨ã‚Šã®ã€Œç¾æ™‚ç‚¹ã§å®Ÿè£…æ¸ˆã¿ã®ç¯„å›²ã€ã¨
ã€Œä»Šå¾Œã® TODOï¼ˆå¾Œå›ã—ã«ã—ãŸã‚‚ã®ï¼‰ã€ã‚’æ˜ç¤ºã™ã‚‹ã€‚

10-1. å®Ÿè£…æ¸ˆã¿ï¼ˆBackend / APIï¼‰

- `GET /api/public/farms` ã¯ PublicFarmList API Design ã«å¾“ã£ã¦å®Ÿè£…æ¸ˆã¿ã€‚
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ `PublicFarmCardDTO` é…åˆ—ï¼‹ãƒšãƒ¼ã‚¸æƒ…å ±ï¼ˆ`ok, page, page_size, total_count, has_next, no_farms_within_100km`ï¼‰ã§è¿”å´ã•ã‚Œã‚‹ã€‚
- å…¬é–‹æ¡ä»¶ã¯ Farmer Domain V2 ã®
  - `farms.active_flag == 1`
  - `farms.is_accepting_reservations == true`
  - `farms.is_ready_to_publish == true`
  ã‚’æº€ãŸã™ farm ã®ã¿ã€‚
- è·é›¢è¨ˆç®—ï¼ˆHaversineï¼‰ã¨ã€Œé–‹å§‹3æ™‚é–“å‰ç· åˆ‡ã€ãƒ­ã‚¸ãƒƒã‚¯ã«åŸºã¥ã
  `next_pickup_start / next_pickup_deadline / next_pickup_display` ã‚‚å®Ÿè£…æ¸ˆã¿ã€‚
- `owner_label`, `owner_address_label` ã®ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã¯ä»•æ§˜ã©ãŠã‚Šã«å‹•ä½œã—ã¦ãŠã‚Šã€
  ãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰ã® JSON ã‚’ç¢ºèªæ¸ˆã¿ã€‚

10-2. å®Ÿè£…æ¸ˆã¿ï¼ˆFrontend / Public ä¸€è¦§ãƒšãƒ¼ã‚¸ï¼‰

- `FarmsListPage.tsx` ã¯ V2 ã® `PublicFarmCardDTO[]` ã‚’ãã®ã¾ã¾å—ã‘å–ã‚Šè¡¨ç¤ºã™ã‚‹ã€‚
- ä¸€è¦§ã‚«ãƒ¼ãƒ‰ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯ V1 ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ç¶­æŒã—ã¤ã¤ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‰²ã‚Šå½“ã¦ã¯æ¬¡ã®é€šã‚Šï¼š
  - å¤§ãã„ç”»åƒï¼š`pr_images[0]`
  - é¡”ã‚¢ã‚¤ã‚³ãƒ³ï¼š`face_image_url`
  - å¤ªå­—ã‚¿ã‚¤ãƒˆãƒ«ï¼š`pr_title`
  - ãã®ä¸‹ã®è¡Œï¼š`owner_label`ï¼ˆâ—¯â—¯ã•ã‚“ã®ãŠç±³ï¼‰
  - èª¬æ˜è¡Œï¼š`owner_address_label`ï¼ˆâ—¯â—¯çœŒâ—¯â—¯å¸‚â—¯â—¯ç”ºã®è¾²å®¶ï¼‰
  - ä¾¡æ ¼ãƒ»æ¬¡å›å—ã‘æ¸¡ã—ï¼š`price_10kg`, `next_pickup_display`
- ãŠæ°—ã«å…¥ã‚Šãƒãƒ¼ãƒˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆ`localStorage` ãƒ™ãƒ¼ã‚¹ï¼‰ã§å‹•ä½œã€‚
- ä¸€è¦§ã®å„ã‚«ãƒ¼ãƒ‰ã‹ã‚‰ `/farms/{farm_id}` ã¸ã®é·ç§»ã¯æ­£å¸¸ã«å‹•ä½œã€‚
- `MapLayerPortal` ã¯ V2 ç”¨ã«æ›¸ãæ›ãˆæ¸ˆã¿ã§ã€
  ä¸€è¦§ã¨åŒã˜ `PublicFarmCardDTO[]` ã‚’å—ã‘ã¦ãƒ”ãƒ³ãƒ»ä¸‹éƒ¨ã‚·ãƒ¼ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã€‚
  - ãƒ”ãƒ³ä½ç½®ï¼š`pickup_lat`, `pickup_lng`ï¼ˆ20ã€œ30m ã®å¾®ã‚ªãƒ•ã‚»ãƒƒãƒˆä»˜ãï¼‰
  - ãƒãƒ–ãƒ«è¡¨ç¤ºï¼š`Â¥{price_10kg}`
  - ä¸‹éƒ¨ã‚·ãƒ¼ãƒˆï¼š`pr_images[0]`, `pr_title`, `owner_address_label`,
    `price_10kg`, `next_pickup_display` ã‚’è¡¨ç¤ºã—ã€`/farms/{farm_id}` ã¸ãƒªãƒ³ã‚¯ã€‚

10-3. ã¾ã æœªå®Ÿè£…ã§ã€å¾Œã®ãƒ•ã‚§ãƒ¼ã‚ºã«å›ã™é …ç›®ï¼ˆTODOï¼‰

10-4. å®Ÿè£…æ¸ˆã¿ï¼ˆFrontend / Public Farm Detail ãƒšãƒ¼ã‚¸ï¼‰

- Detail ãƒšãƒ¼ã‚¸ã¯ `GET /api/public/farms/{farm_id}`ï¼ˆPublicFarmDetailDTOï¼‰ã‚’å”¯ä¸€ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦ä½¿ç”¨ã€‚
- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆface_image_url, owner_label ãªã©ï¼‰
- ä¾¡æ ¼ã‚«ãƒ¼ãƒ‰ï¼ˆprice_5kg / price_10kg / price_25kgï¼‰
- åç©«å¹´ + å“ç¨®è¡¨ç¤ºï¼ˆharvest_year / rice_variety_labelï¼‰
- PR ãƒ†ã‚­ã‚¹ãƒˆãƒ»ç”»åƒï¼ˆpr_title / pr_text / pr_imagesï¼‰
- å—ã‘æ¸¡ã—æ™‚é–“ï¼ˆnext_pickup_displayï¼‰
- åœ°å›³ + ä½æ‰€ï¼ˆpickup_lat / pickup_lng / pickup_address_labelï¼‰
ã“ã‚Œã‚‰ã‚’ FarmDetailPage å†…ã®åˆ†å‰²ã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ãã®ã¾ã¾æ¸¡ã—ã¦è¡¨ç¤ºã™ã‚‹ã€‚



ä»¥ä¸‹ã¯ä»•æ§˜ä¸Šã¯æƒ³å®šã—ã¦ã„ã‚‹ãŒã€2025-11-22 æ™‚ç‚¹ã§ã¯ã‚ãˆã¦æœªå®Ÿè£…ã¨ã—ã€
å°†æ¥ã®ãƒ•ã‚§ãƒ¼ã‚ºã§å¯¾å¿œã™ã‚‹ã€‚

- ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  - API ã¯ `page / page_size / has_next` ã‚’è¿”ã—ã¦ã„ã‚‹ãŒã€
    ãƒ•ãƒ­ãƒ³ãƒˆå´ã¯ç¾çŠ¶ `page=1` ã®ã¿å–å¾—ã—ã€2ãƒšãƒ¼ã‚¸ç›®ä»¥é™ã®è‡ªå‹•ãƒ­ãƒ¼ãƒ‰ã¯è¡Œã£ã¦ã„ãªã„ã€‚
- åœ°å›³ã®ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°ï¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½ç½®é€£å‹•
  - `MapLayerPortal` ã® `mapCenter` ã¯ç¾åœ¨ã€å¾³å³¶çœŒä¸­å¿ƒåº§æ¨™ã®å›ºå®šå€¤ã€‚
  - ãƒ–ãƒ©ã‚¦ã‚¶ã® geolocation ã‚„æ¤œç´¢æ¡ä»¶ï¼ˆlat/lng ã‚¯ã‚¨ãƒªï¼‰ã«å¿œã˜ã¦
    ä¸­å¿ƒã‚’å‹•ã‹ã™ãƒ­ã‚¸ãƒƒã‚¯ã¯ã¾ã å…¥ã‚Œã¦ã„ãªã„ã€‚
- `no_farms_within_100km` ãƒ•ãƒ©ã‚°ã® UI è¡¨ç¤º
  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã¯å«ã¾ã‚Œã¦ã„ã‚‹ãŒã€ãƒ•ãƒ­ãƒ³ãƒˆå´ã®æ³¨æ„æ–‡è¡¨ç¤ºã¯æœªå®Ÿè£…ã€‚

pickup_time_utils.compute_next_pickup() ã‚’å…±é€šåˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€
ä¸€è¦§ï¼è©³ç´°ï¼Confirmï¼äºˆç´„APIã® 3æ™‚é–“å‰ç· åˆ‡ãƒ­ã‚¸ãƒƒã‚¯ã¯ã™ã¹ã¦åŒæœŸã—ã¦ã„ã‚‹ã€‚ï¼‰


ä¸Šè¨˜ã®çŠ¶æ…‹ã‚’ã‚‚ã£ã¦ã€Public Farm List / MapLayerPortal ã«ã¤ã„ã¦ã¯
ã€ŒCustomer Booking Domain V2 ã® Phase 1ï¼ˆä¸€è¦§ï¼‹åœ°å›³ã®åŸºæœ¬ä½“é¨“ï¼‰ã€ãŒå®Œäº†ã—ãŸã‚‚ã®ã¨ã™ã‚‹ã€‚
ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½ç½®é€£å‹•ã¯ Phase 2 ä»¥é™ã®æ”¹å–„ã‚¿ã‚¹ã‚¯ã¨ã—ã¦æ‰±ã†ã€‚
