📘 予約kg制限まわり：設計・実装・保守メモ（確定版）
1. このスレッドで達成したこと（事実）
機能面

予約できる米の合計重量に 上限（現在 50kg） を設定

0kg の予約は不可

50kg は OK / 51kg 以上は不可

フロント・API の 三重防御を構築

技術面

kg 制限の「数値」と「ロジック」を分離

フロントと API で 同じ思想・同じ責務分離を採用

将来の制限変更（kg変更・条件分岐）を想定した構造を確定

2. 現在の全体構造（重要）
[ フロント ]
order_limits.json   ← 数値の源泉
   ↓
orderRules.ts       ← 計算・判定ロジック
   ↓
UI（ボタン無効化・エラー表示）

[ API ]
app_v2/config/order_limits.py   ← 数値の源泉
   ↓
app_v2/domain/order_quantity.py ← 計算・判定ロジック
   ↓
app_v2/customer_booking/api/confirm_api.py

原則

数値は設定ファイル

ロジックは domain

API は判断結果を使うだけ

3. 予約kg制限の仕様（確定）
現在の仕様

合計重量 = sum(size_kg × quantity)

合計 = 0 → 予約不可

合計 ≤ 50 → 予約可

合計 > 50 → 予約不可

API 側の実際の挙動

quantity = 0
→ DTO（Pydantic）で 422

合計 > 50kg
→ domain ロジックで 400

※ 422 と 400 が混在するのは 仕様どおり
（構造エラーと業務ルールエラーを分離している）

4. 「kg制限を変更したい」ときに触る場所（最重要）
🔁 kg 上限を変更したい場合
フロント

変更箇所：1か所

order_limits.json

{
  "MAX_TOTAL_KG": 50
}


例：80kg にする

{
  "MAX_TOTAL_KG": 80
}

API

変更箇所：1か所

app_v2/config/order_limits.py

DEFAULT_MAX_TOTAL_KG = 50


例：

DEFAULT_MAX_TOTAL_KG = 80

❌ 触ってはいけない場所

order_quantity.py

confirm_api.py

フロントのロジック本体

DTO

理由：

ロジックは「数値を知らない」前提で設計済み

5. なぜこの設計にしたか（判断理由）
① フロントと API を同時に変えやすくするため

数値を分散させると事故る

「設定だけ変えればよい」状態を作った

② 将来の条件分岐に耐えるため

将来こうなっても対応可能：

一般ユーザー：50kg

ノーショー常習者：15kg

特定農家：30kg

→ 数値の出し分けを設定側でやるだけ
→ domain ロジックは変更不要

③ 仕様が「変わる前提」であることを明示するため

kg制限はビジネス判断であり、
コードの責務ではない

6. 今後の保守・変更時の注意点
やってよいこと

kg 制限の数値を変更

設定ファイルの分岐（role / flag / consumer_id）

エラーメッセージ文言の調整

やらないほうがよいこと

domain ロジックに数値を書く

confirm_api に条件分岐を足す

フロントと API で別々の制限ルールを持つ

7. テスト方法（再確認用）
単体（Python REPL）

validate_order_quantity() で 0kg / 50kg / 51kg を確認

API

POST /api/confirm

50kg → 200

51kg → 400

UI

0kg → ボタン無効

51kg → エラー表示・遷移不可

8. この機能の現在のステータス

✅ 設計：完了
✅ 実装：完了
✅ 単体テスト：完了
✅ API結合：完了
🔜 UX微調整：必要になったら

👉 「完成扱い」でよい状態

最終ひとこと（保守者向け）

kg 制限を変えたくなったら
「ロジックを探すな。設定を探せ」