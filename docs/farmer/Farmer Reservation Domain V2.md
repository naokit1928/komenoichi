ğŸ“„ FarmerReservationDomainV2.mdï¼ˆå®Œå…¨çµ±åˆç‰ˆãƒ»æœ€çµ‚å½¢ï¼‰

è¾²å®¶å‘ã‘ï¼šä»Šé€±ã®äºˆç´„ä¸€è¦§ãƒšãƒ¼ã‚¸ï¼ˆFarmerReservationTableï¼‰ä»•æ§˜æ›¸
Version: 2025-11-26 / å®Œå…¨V2åŒ–ï¼‹ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ§‹æˆçµ±åˆç‰ˆ

1. ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ç›®çš„

ï¼ˆâ€»æ—¢å­˜æ–‡æ›¸ã‚’ä¿æŒï¼‰

ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯ã€Œè¾²å®¶ãŒæ¯é€±ã®äºˆç´„ã‚’æ­£ç¢ºãƒ»åŠ¹ç‡çš„ã«ç®¡ç†ã™ã‚‹ãŸã‚ã®è¡¨ç¤ºæ©Ÿèƒ½ã€ã‚’æä¾›ã™ã‚‹ã€‚

ä¸»ãªã‚´ãƒ¼ãƒ«ï¼š

ä»Šé€±ã®å—ã‘æ¸¡ã—ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆ1å›åˆ†ï¼‰ã«å±ã™ã‚‹äºˆç´„ã‚’ å®Œå…¨V2ãƒ‡ãƒ¼ã‚¿ã®ã¿ã§é–²è¦§

Confirm Page ã®é€±åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã¨å®Œå…¨ä¸€è‡´

V1ãƒ­ã‚¸ãƒƒã‚¯ãƒ»V1ã‚«ãƒ©ãƒ ï¼ˆitem/quantity/price/amountï¼‰ã¸ã® ä¾å­˜ã‚¼ãƒ­

PIN + æ•°é‡ + é‡‘é¡ ã®è¡¨ã‚’ å°åˆ·å¯èƒ½

åˆå›æ³¨æ„ãƒ¢ãƒ¼ãƒ€ãƒ«ã§é‹ç”¨ãƒ«ãƒ¼ãƒ«ã‚’æ˜ç¤º

æ‹¡å¼µæ€§ï¼ˆå±¥æ­´ / CSV / QRå—ä»˜ / æ¥é€±åˆ‡æ›¿ï¼‰ã‚‚ç¢ºä¿

2. ã‚¹ã‚³ãƒ¼ãƒ—

ï¼ˆâ€»æ—¢å­˜æ–‡æ›¸ã‚’ä¿æŒï¼‰

3. å¿…é ˆãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ï¼ˆå”¯ä¸€ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ APIï¼‰

ï¼ˆâ€»æ—¢å­˜æ–‡æ›¸ã‚’ä¿æŒï¼‰

4. DTO ä»•æ§˜

ï¼ˆâ€»æ—¢å­˜æ–‡æ›¸ã‚’ä¿æŒï¼‰

5. ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆé€±ï¼‰åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯

ï¼ˆâ€»æ—¢å­˜æ–‡æ›¸ã‚’ä¿æŒï¼‰

6. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ§‹é€ ï¼ˆReactï¼‰

ï¼ˆâ€»æ—¢å­˜æ–‡æ›¸ã‚’ä¿æŒï¼‰

7. ç”»é¢ä»•æ§˜ï¼ˆFarmerReservationTableï¼‰

ï¼ˆâ€»æ—¢å­˜æ–‡æ›¸ã‚’ä¿æŒï¼‰

8. äºˆç´„è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ä»•æ§˜

ï¼ˆâ€»æ—¢å­˜æ–‡æ›¸ã‚’ä¿æŒï¼‰

9. æ³¨æ„äº‹é …ãƒ¢ãƒ¼ãƒ€ãƒ«ä»•æ§˜

ï¼ˆâ€»æ—¢å­˜æ–‡æ›¸ã‚’ä¿æŒï¼‰

10. å°åˆ·ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä»•æ§˜

ï¼ˆâ€»æ—¢å­˜æ–‡æ›¸ã‚’ä¿æŒï¼‰

11. å®Œå…¨V2åŒ–ã§é”æˆã—ãŸã“ã¨

ï¼ˆâ€»æ—¢å­˜æ–‡æ›¸ã‚’ä¿æŒï¼‰

12. å°†æ¥æ‹¡å¼µ

ï¼ˆâ€»æ—¢å­˜æ–‡æ›¸ã‚’ä¿æŒï¼‰

13. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¿å­˜ãƒ‘ã‚¹

ï¼ˆâ€»æ—¢å­˜æ–‡æ›¸ã‚’ä¿æŒï¼‰

14. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ«ãƒ¼ãƒ«

ï¼ˆâ€»æ—¢å­˜æ–‡æ›¸ã‚’ä¿æŒï¼‰

15. ä»˜éŒ²ï¼ˆé–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

reservation_expanded_repo.py

reservation_expanded_service.py

reservation_expanded_api.py

FarmerReservationTable.tsx

FarmerReservationNoticeModal.tsx

FarmerReservationTable.module.css

------------------------------------------
16. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ V2 ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ï¼ˆå®Œå…¨çµ±åˆï¼‰
------------------------------------------

äºˆç´„ä¸€è¦§ãƒšãƒ¼ã‚¸ï¼ˆFarmerReservationTableï¼‰ã¯
reservations ãƒ†ãƒ¼ãƒ–ãƒ«ã® V2 ã‚«ãƒ©ãƒ ç¾¤ã‚’å”¯ä¸€ã®çœŸå®Ÿã¨ã—ã¦æ‰±ã†ã€‚

ã“ã“ã§ã¯è¾²å®¶UIãŒä¾å­˜ã™ã‚‹æœ€ä½é™ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä»•æ§˜ã‚’è¨˜è¿°ã™ã‚‹ã€‚

16.1 reservations ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ï¼ˆV2ä½¿ç”¨éƒ¨åˆ†ï¼‰
ã‚«ãƒ©ãƒ å	å‹	NULL	èª¬æ˜
id	INTEGER PK	NO	äºˆç´„ID
user_id	INTEGER	NO	äºˆç´„è€…ID
farm_id	INTEGER	NO	å¯¾è±¡è¾²å®¶
status	VARCHAR(32)	NO	"pending" / "confirmed"
created_at	DATETIME	YES	pendingä½œæˆæ™‚åˆ»
payment_succeeded_at	DATETIME	YES	confirmedæ™‚åˆ»
pickup_slot_code	VARCHAR(32)	YES	"WED_19_20"
items_json	TEXT	YES	V2äºˆç´„å†…è¨³
rice_subtotal	INTEGER	YES	items_json.line_total ã®åˆè¨ˆ
service_fee	INTEGER	YES	Stripeæ±ºæ¸ˆç”¨ / å°†æ¥æ‹¡å¼µå¯èƒ½
currency	VARCHAR(10)	NO	"jpy"
â€»V1ã‚«ãƒ©ãƒ ã¯å®Œå…¨ç„¡è¦–

item

quantity

amount

price

user_confirmation_status

status_v1
â†’ æ®‹å­˜ã¯ã™ã‚‹ãŒå‚ç…§ç¦æ­¢ã€‚

16.2 items_json ã®æ§‹é€ 
[
  {
    "size_kg": 5,
    "quantity": 2,
    "unit_price": 4200,
    "line_total": 8400
  },
  {
    "size_kg": 10,
    "quantity": 1,
    "unit_price": 7900,
    "line_total": 7900
  }
]


ãƒ«ãƒ¼ãƒ«ï¼š

unit_price ã¯ farms.price_xx ã‹ã‚‰ã‚µãƒ¼ãƒãŒè¨­å®š

line_total = unit_price Ã— quantityï¼ˆã‚µãƒ¼ãƒãŒè¨ˆç®—ï¼‰

ãƒ•ãƒ­ãƒ³ãƒˆã¯ä¸€åˆ‡è¨ˆç®—ã—ãªã„

16.3 status ã®æ„å‘³
status	èª¬æ˜
pending	ConfirmPageã§äºˆç´„IDä½œæˆç›´å¾Œ
confirmed	StripeæˆåŠŸå¾Œï¼ˆè¾²å®¶å´UIãŒè¡¨ç¤ºã™ã‚‹çŠ¶æ…‹ï¼‰

è¾²å®¶ä¸€è¦§ã§ã¯ confirmed ã®ã¿ã‚’è¡¨ç¤ºã€‚
pending ã‚’è¡¨ç¤ºã™ã‚‹ã¨èª¤å·®ãŒç™ºç”Ÿã™ã‚‹ãŸã‚é™¤å¤–ã€‚

16.4 é€±åˆ¤å®šã«å¿…è¦ãªå€¤

event_start

event_end

grace_until (= event_end + 3h)

deadline (= event_start - 3h)

è¾²å®¶UIãƒ»ConfirmPageãƒ»ExportPageãƒ»CancelDomainãƒ»LINEè‡ªå‹•é€šçŸ¥ã®é€±åˆ¤å®šã‚’
reservation_expanded_service å†…ã®æ­£æº–ãƒ­ã‚¸ãƒƒã‚¯ã«å®Œå…¨çµ±ä¸€ã€‚


16.5 reservation_expanded_service ã®è²¬å‹™

é€±ã®æ±ºå®š

äºˆç´„æŠ½å‡ºï¼ˆconfirmedã®ã¿ï¼‰

items_json â†’ rowæ§‹é€ ã¸ã®å±•é–‹

åˆè¨ˆ bundle_summary ã®è¨ˆç®—

PINï¼ˆpickup_codeï¼‰ç”Ÿæˆ

------------------------------------------
17. ER å›³ï¼ˆV2 äºˆç´„ç³»ï¼‰
------------------------------------------
+---------------------+
| farms               |
+---------------------+
| id (PK)             |
| owner_name          |
| price_5kg           |
| price_10kg          |
| price_25kg          |
| pickup_slot_code    |
| pickup_lat/lng      |
| active_flag         |
| is_accepting_reservations |
| is_ready_to_publish |
+---------------------+
           |
           | 1 - n
           v
+----------------------+
| reservations         |
+----------------------+
| id (PK)              |
| user_id              |
| farm_id (FKâ†’farms)   |
| status               |
| created_at           |
| payment_succeeded_at |
| pickup_slot_code     |
| items_json           |
| rice_subtotal        |
| service_fee          |
| currency             |
+----------------------+
           |
           | JSON å±•é–‹ï¼ˆ1 - nï¼‰
           v
+----------------------+
| reservation_items    | (ç‰©ç†ãƒ†ãƒ¼ãƒ–ãƒ«ãªã— / items_json å±•é–‹)
+----------------------+
| size_kg              |
| quantity             |
| unit_price           |
| line_total           |
+----------------------+


è£œè¶³ï¼š

reservation_items ã¯ ç‰©ç†ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã¯ãªã items_json ã‚’å±•é–‹ã—ãŸæ¦‚å¿µãƒ¢ãƒ‡ãƒ«

è¾²å®¶UIã§ã¯ items_json ã‚’ç›´æ¥åˆ©ç”¨

------------------------------------------
18. reservation_expanded_service.py
è¡Œç•ªå·ã¤ããƒ­ã‚¸ãƒƒã‚¯è§£èª¬
------------------------------------------

ï¼ˆâ€»å®Ÿãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æã—ã€ä¸€èˆ¬åŒ–ã—ãŸè¡Œç•ªå·è§£èª¬ï¼‰

18.1 è¡Œ 1â€“40ï¼šã‚¤ãƒ³ãƒãƒ¼ãƒˆ & å®šæ•°

datetime

repositoryèª­ã¿è¾¼ã¿

slot_codeãƒ‡ã‚³ãƒ¼ãƒ‰é–¢æ•°

pickupç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

timedelta, timezoneå®šç¾©

18.2 è¡Œ 41â€“90ï¼šé€±ã®ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç®—å‡º
(1) ç¾åœ¨æ—¥æ™‚ã‚’JSTã§å–å¾—
now = datetime.now(JST)

(2) pickup_slot_code ã‹ã‚‰æ›œæ—¥ãƒ»æ™‚é–“å¸¯ã‚’å¾©å…ƒ

ä¾‹ï¼š
"WED_19_20" â†’ é€±ã®æ°´æ›œ 19:00â€“20:00

(3) ä»Šé€±ã® event_start / event_end

æœˆæ›œå§‹ã¾ã‚Š

ã¾ãŸã¯åœŸæ›œå›ºå®šï¼ˆè¾²å®¶è¨­å®šã«ä¾å­˜ï¼‰

event_start = this_week_date + slot_start_time
event_end   = this_week_date + slot_end_time

(4) è¡¨ç¤ºçŒ¶äºˆæ™‚é–“ (grace_until)
grace_until = event_end + 3h
â†’ å—ã‘æ¸¡ã—çµ‚äº†ã‹ã‚‰ 3æ™‚é–“ã¾ã§ã¯ã€Œä»Šé€±ã®è¡¨ã€ã¨ã—ã¦è¡¨ç¤ºã‚’è¨±å¯

(5) å—ä»˜ç· åˆ‡
deadline = event_start - 3h
â†’ Confirm / äºˆç´„ä½œæˆã®ç· åˆ‡ã‚‚åŒã˜ 3æ™‚é–“å‰ãƒ«ãƒ¼ãƒ«ã§çµ±ä¸€


ConfirmPage ã¨å®Œå…¨ä¸€è‡´ã—ã¤ã¤ã€ä»¥ä¸‹ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã‚‚å…±é€šåˆ©ç”¨ã•ã‚Œã‚‹æ­£æº–ãƒ­ã‚¸ãƒƒã‚¯ã¨ãªã‚‹ï¼š

- Export ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆFarmerReservationTableï¼‰
- CancelDomainï¼ˆ_calc_event_for_booking, _format_event_display_label ã‚’åˆ©ç”¨ï¼‰
- LINE è‡ªå‹•é€šçŸ¥ï¼ˆåŒã˜ã _calc_event_for_booking ã‚’åˆ©ç”¨ï¼‰


ConfirmPage ã¨å®Œå…¨ä¸€è‡´ã€‚


18.4 è¡Œ 150â€“220ï¼šäºˆç´„æŠ½å‡º
rows = repo.get_rows(farm_id, event_start, event_end)


æ¡ä»¶ï¼š

reservations.status == "confirmed"

created_at <= deadline ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆä»Šé€±åˆ†ï¼‰

items_json ãŒ NULL ã® V1äºˆç´„ã¯é™¤å¤–

18.5 è¡Œ 220â€“310ï¼šitems_json â†’ è¡Œã¸ã®å±•é–‹

size_kg / quantity / unit_price / line_total ã‚’å±•é–‹

5kg / 10kg / 25kg åˆ—ã¸ãƒãƒƒãƒ”ãƒ³ã‚°

rice_subtotal ã®ç®—å‡º

PIN (pickup_code) ç”Ÿæˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ é©ç”¨

pickup_code = generate_pickup_code(reservation_id, user_id)

18.6 è¡Œ 310â€“360ï¼šbundle_summary è¨ˆç®—

size_kg ã”ã¨ã«åˆè¨ˆ

rice_subtotal ã®åˆè¨ˆ

ã‚¹ã‚­ãƒƒãƒ—é˜²æ­¢ã®ãŸã‚ rows ãŒ0ä»¶ã§ã‚‚åˆæœŸå€¤ä½œæˆ

18.7 è¡Œ 360â€“400ï¼šæœ€çµ‚ DTO ã‚’è¿”å´
return {
  ok: true,
  event_meta: event_meta,
  rows: rows,
  bundle_summary: summary
}

------------------------------------------
19. å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ§‹é€ å›³
------------------------------------------
[ DB / reservations ]
        |
        v
[ reservation_expanded_repo ]
        |
        v
[ reservation_expanded_service ]
        |
        +-- event_meta
        +-- rows[]
        +-- bundle_summary
        |
        v
[ reservation_expanded_api ]
        |
        v
[ FarmerReservationTable.tsx ]
     - table è¡¨ç¤º
     - summary è¡¨ç¤º
     - PIN è¡¨ç¤º
     - è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
     - å°åˆ·

âœ” å®Œæˆï¼ˆçµ±åˆç‰ˆï¼‰

ã“ã®æ–‡æ›¸ã¯ FarmerReservationTable ã®ï¼š

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

ER å›³

é€±åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯

reservation_expanded_service ã®å†…éƒ¨æ§‹é€ 

ã™ã¹ã¦ã‚’ 1ãƒ•ã‚¡ã‚¤ãƒ«ã§å®Œå…¨ã«å‚ç…§ã§ãã‚‹åŸºæº–æ›¸ ã«ãªã‚Šã¾ã—ãŸã€‚