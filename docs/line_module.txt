LINE連携モジュール（V2）構造改革・保守運用ドキュメント
1. このモジュールの目的

本 LINE モジュールは、以下のフローを 責務分離された安全な構造で実現する。

confirm ページで決済ボタン押下

未 LINE 連携ユーザーは LINE ログインへ遷移

LINE 認証完了後

購入者 → 元の confirm 画面へ復帰

農家 → farmer settings 画面へ遷移

その後 Stripe 決済に進む（LINE モジュールの責務外）

重要
このモジュールは
👉 「LINE 認証とユーザー連携」まで
👉 決済や予約確定は扱わない

2. 最終フォルダ構成（V2 完成形）
app_v2/integrations/line/
├─ api/
│   └─ line_api.py
│
├─ services/
│   ├─ line_oauth_service.py
│   └─ line_link_service.py
│
├─ repository/
│   └─ line_link_repository.py
│
└─ utils/
    ├─ state_signer.py
    └─ url_builder.py


この構成は pickup_settings / reservation / notification と同じ
V2 共通設計原則に従っている。

3. 各レイヤーの責務（絶対ルール）
3.1 api/line_api.py（FastAPI 層）

責務

HTTP 入出力のみ

クエリ取得

Cookie 設定 / 削除

RedirectResponse の生成

禁止事項

DB 接続

OAuth ロジック

業務判断（consumer / farmer 判定など）

変更してよい例

Cookie 属性（Secure / SameSite）

redirect URL の組み立て方法

エラーハンドリングの表現

3.2 services/line_oauth_service.py（技術サービス）

責務

LINE OAuth の仕様をすべてここに隔離

code → access token → profile

state の署名・検証（utils 使用）

ここに書いてよいもの

LINE API endpoint

scope 変更

OpenID / id_token 対応

timeout / retry 調整

ここに書いてはいけないもの

DB 操作

consumer / farmer 判定

redirect 先の決定

👉 LINE 仕様変更があった場合は
ここだけを修正すればよい

3.3 services/line_link_service.py（業務サービス）

責務

LINE user_id を受け取る

consumer フロー / farmer フローを判断

repository を使って DB 状態を確定

「連携結果」という 業務的事実 を返す

重要な設計判断

consumer は 常に ensure（現行挙動維持）

farm_id が指定されていなければ新規 farm 作成

API 層に判断を返すだけで redirect はしない

将来の拡張ポイント

LINE ロール追加（例：staff）

複数 farm 所有対応

LINE 未連携ユーザーの仮登録

3.4 repository/line_link_repository.py（DB 層）

責務

sqlite3 のみを扱う

SQL 実行と commit / rollback

判断ロジックを持たない

絶対ルール

DB パスは resolve_db_path() のみ使用

Service / API を import しない

変更時の注意

schema 変更時はここだけ修正

UNIQUE 制約や NOT NULL に強く依存しているため
DB 変更時は必ずここを確認

3.5 utils/
state_signer.py

OAuth state の署名・検証

JSON + timestamp + HMAC

安全性

改ざん防止済み

secret は LINE_CHANNEL_SECRET を利用

url_builder.py

redirect URL 組み立て

クエリの安全な merge

他モジュールでも再利用可

4. 依存関係ルール（壊してはいけない）
api
 ↓
services（業務 / OAuth）
 ↓
repository
 ↓
sqlite3


上位層が下位層を import するのは OK

逆方向 import は 禁止

utils は全層から利用可能（pure）

5. main.py 側の注意点
ルーター登録
from app_v2.integrations.line.api.line_api import router as line_router_v2
app.include_router(line_router_v2)


構造変更時に最も壊れやすいポイント
→ フォルダ移動時は必ずここを確認すること。

6. テスト・運用チェックリスト
ローカル確認

/api/line/login?return_to=...

LINE ログイン完了

/api/line/callback 到達

DB に consumer / user / farm が作成される

正しい redirect

Cookie line_linked=1 が付与される

本番運用時

LINE_CHANNEL_ID / SECRET / REDIRECT_URI の env 確認

FRONTEND_BASE_URL の確認

https 時の cookie secure 属性調整

7. よくある修正と影響範囲
変更内容	修正箇所
LINE scope 変更	line_oauth_service
redirect 振る舞い変更	line_api
farm 作成ルール変更	line_link_service
DB schema 変更	line_link_repository
セキュリティ強化	state_signer
8. 結論（重要）

この LINE モジュールは：

動作確認済み

V2 構造改革基準を完全に満たす

将来の変更点が局所化されている

他モジュールへの影響が出ない