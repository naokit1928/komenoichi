confirm 系 構造改革まとめ（保存用）
1. 改革の目的

confirm 系（旧 reservation 系）は当初、以下の問題を抱えていた。

confirm に無関係な機能が混在

repo が read / write / cancel / history を兼任

Service が DB・SQL・価格計算・状態遷移まで抱えていた

cancel / confirm で状態遷移の実装方針が不統一

本改革の目的は：

confirm の責務を「予約確定フローの制御」に限定する

状態遷移・履歴・通知・参照をすべて外部に切り出す

V2 基準（API / Service / Repo / Domain 分離）を満たす

2. このスレッドで「confirm から外に出した機能」
2.1 状態遷移（最重要）
新設

booking_lifecycle_service.py

移動した機能

status = confirmed

status = cancelled

トランザクション管理

冪等性（二重 confirm / cancel 防止）

意味論の確定

payment_succeeded_at
= 手数料300円の決済成功時刻

仕様上：

confirm 時に必ず入る

cancel されても 消さない

status と payment は独立軸



2.2 cancel 系（confirm から完全分離）
CancelService の責務（確定）

キャンセル可否判定（3時間前）

キャンセル確認ページ用データ構築

CancelToken 検証

REMINDER 削除

CANCEL_COMPLETED 通知送信

confirm から消えたもの

cancel 処理

cancel DB 更新

token 検証

👉 confirm は cancel を一切知らない

2.3 consumer 履歴系（confirm から完全分離）
新設

consumer_history_repo.py

consumer_history_api.py

移動した機能

get_last_confirmed_farm_id

「前回予約した農家を優先表示する」ロジック

接続先

FarmsListPage

MapLayerPortal

👉 confirm / reservation_repo から 履歴参照は完全排除

2.4 reservation_repo の整理
削除した責務

cancel 用 UPDATE

consumer 履歴参照

confirm 専用ロジック

残した責務

reservation の read-only 取得

booked / cancel / confirm 共通で使える参照

👉 「reservation read の共通入口」として正しい位置に縮退

3. 現在の confirm 系ファイルの評価
3.1 confirm_api.py

HTTP 入出力

最低限の入力チェック

ConfirmService への完全委譲

✅ V2 基準を完全に満たす（完成）

3.2 reservation_repo.py

reservation の read-only 参照

confirm 専用ではないが、それが正しい

✅ 完成

3.3 confirm_service.py（重要）
現在の責務

フロント入力の業務的検証

締切判定（client / server）

注文内容の正当性検証



以下は confirm の本来責務ではない：

sqlite3 接続管理

SQL（INSERT INTO reservations）

farms テーブルからの価格取得

DB パス解決

👉 confirm_service は まだ V1 の尻尾を引きずっている

4. これから confirm から外に出す予定のファイル（未完了）
4.1 新設予定：confirm_repository（仮）
想定責務

insert_pending_reservation(...)

fetch_farm_price(...)

confirm_service から削除予定

_get_conn

_fetch_price

SQL 文

sqlite3 import

4.2 最終的な confirm_service のあるべき姿

confirm_service は最終的に：

業務フロー制御

順序の保証

Service 間のオーケストレーション

のみを行う

DB / SQL / テーブル構造を一切知らない状態がゴール。

5. 現在地の総括

cancel：完成

consumer 履歴：完成

状態遷移：完成

confirm API：完成

confirm Service：80% 完成

confirm Repository 分離：未着手（次の作業）

👉 confirm は「最後に残る難所」であり、
この順序は正しい

6. 次にやるべき作業（再開用メモ）

confirm_repository を新設

confirm_service から DB / SQL を完全排除

confirm_service を orchestration 専用にする

動作確認（POST /api/confirm）

この文書は
「なぜこの構造になっているか」「何が終わっていて何が残っているか」
を次の作業者が一切迷わず理解できることを目的に書いています。

このまま .md や 構造改革_confirm.txt として保存してください。


