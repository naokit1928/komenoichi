DB Migration é‹ç”¨æ‰‹é †ï¼ˆKOMET / Render + SQLiteï¼‰
ç›®çš„

Render æœ¬ç•ªã® æ°¸ç¶šãƒ‡ã‚£ã‚¹ã‚¯ï¼ˆSQLiteï¼‰ ã‚’å®‰å…¨ã«å¤‰æ›´ã™ã‚‹

shell ã§ã® import / path ã‚¨ãƒ©ãƒ¼ã‚’å®Œå…¨ã«é˜²ã

ã€Œã©ã“ã§ãƒ»ä½•ã‚’ãƒ»ã©ã†å®Ÿè¡Œã™ã‚‹ã‹ã€ã‚’å›ºå®šåŒ–ã™ã‚‹

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆï¼ˆå‰æï¼‰
komet/
â”œâ”€ app_v2/
â”‚  â””â”€ db/
â”‚     â””â”€ core.py        # resolve_db_path()
â”œâ”€ scripts/
â”‚  â”œâ”€ migrations/
â”‚  â”‚  â”œâ”€ mig_farms_email.py
â”‚  â”‚  â””â”€ ï¼ˆä»Šå¾Œã® migrationï¼‰
â”‚  â””â”€ DB_MIGRATION_GUIDE.md  â† ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«

çµ¶å¯¾ãƒ«ãƒ¼ãƒ«ï¼ˆé‡è¦ï¼‰
â‘  DB å¤‰æ›´ã¯ migration ãƒ•ã‚¡ã‚¤ãƒ«ã§ã®ã¿è¡Œã†

âŒ æ‰‹å‹•ã§ sqlite3 ã« ALTER ã‚’æ‰“ãŸãªã„

âŒ ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã« CREATE / ALTER ã—ãªã„

âœ… 1 å¤‰æ›´ = 1 migration ãƒ•ã‚¡ã‚¤ãƒ«

â‘¡ migration ã¯ã€Œå˜ä½“å®Ÿè¡Œã§ãã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€ã«ã™ã‚‹

ã™ã¹ã¦ã® migration ãƒ•ã‚¡ã‚¤ãƒ«ã¯ ä»¥ä¸‹ã‚’å¿…ãšå«ã‚ã‚‹ã€‚

import sys
from pathlib import Path

PROJECT_ROOT = Path(__file__).resolve().parents[2]
sys.path.insert(0, str(PROJECT_ROOT))


ç†ç”±ï¼š

Render shell / ãƒ­ãƒ¼ã‚«ãƒ« / CI ã™ã¹ã¦ã§

PYTHONPATH ã‚’æ‰“ãŸãšã« ä¸€ç™ºå®Ÿè¡Œã™ã‚‹ãŸã‚

migration ãƒ•ã‚¡ã‚¤ãƒ«ã®ç½®ãå ´æ‰€ãƒ»å‘½å
ç½®ãå ´æ‰€ï¼ˆå›ºå®šï¼‰
scripts/migrations/

å‘½åè¦å‰‡ï¼ˆçŸ­ããƒ»æ„å‘³ãŒé€šã‚‹ï¼‰
mig_<table>_<purpose>.py


ä¾‹ï¼š

mig_farms_email.py

mig_reservations_items_json.py

mig_notification_jobs_refactor.py

â€» æ—¥ä»˜ã¯å…¥ã‚Œãªã„
â€» shell ã§ã‚¿ã‚¤ãƒ—ã—ã‚„ã™ã„ã“ã¨ã‚’æœ€å„ªå…ˆ

migration ãƒ•ã‚¡ã‚¤ãƒ«ã®åŸºæœ¬ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆå¿…é ˆï¼‰
# scripts/migrations/mig_xxx.py

import sys
from pathlib import Path
PROJECT_ROOT = Path(__file__).resolve().parents[2]
sys.path.insert(0, str(PROJECT_ROOT))

import sqlite3
from app_v2.db.core import resolve_db_path


def migrate():
    db_path = resolve_db_path()
    print(f"[migrate] db = {db_path}")

    conn = sqlite3.connect(db_path)
    cur = conn.cursor()

    try:
        print("[migrate] begin")
        cur.execute("PRAGMA foreign_keys = OFF;")

        # ---- ã“ã“ã« migration å‡¦ç†ã‚’æ›¸ã ----

        conn.commit()
        print("[migrate] success")

    except Exception as e:
        conn.rollback()
        print("[migrate] failed:", e)
        raise

    finally:
        cur.execute("PRAGMA foreign_keys = ON;")
        conn.close()


if __name__ == "__main__":
    migrate()

SQLite ã§ã‚„ã£ã¦ã‚ˆã„å¤‰æ›´ / ãƒ€ãƒ¡ãªå¤‰æ›´
OKï¼ˆæ¨å¥¨ï¼‰

CREATE TABLE â†’ INSERT â†’ DROP â†’ RENAME

ã‚«ãƒ©ãƒ è¿½åŠ 

ã‚«ãƒ©ãƒ å‰Šé™¤

åˆ¶ç´„å¤‰æ›´ï¼ˆNOT NULL / DEFAULT ãªã©ï¼‰

NGï¼ˆäº‹æ•…ã‚Šã‚„ã™ã„ï¼‰

ALTER TABLE MODIFY COLUMN

æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®ç›´æ¥ ALTER

foreign key ã‚’è·¨ã„ã åŒæ™‚å¤‰æ›´

å®Ÿè¡Œæ‰‹é †ï¼ˆæœ¬ç•ª / Renderï¼‰
â‘  GitHub ã« push æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨
git log -1 --oneline

â‘¡ Render Dashboard â†’ Shell

Shell ã®ã‚«ãƒ¬ãƒ³ãƒˆã¯å¿…ãšï¼š

/opt/render/project/src

â‘¢ migration å®Ÿè¡Œï¼ˆä¸€ç™ºã§é€šã™ï¼‰
python scripts/migrations/mig_xxx.py


â€» PYTHONPATH ã¯ä¸è¦

â‘£ æˆåŠŸãƒ­ã‚°ã®æ¡ä»¶
[migrate] db = /var/data/app.db
[migrate] begin
[migrate] success


ã“ã‚ŒãŒå‡ºãŸã‚‰ å³çµ‚äº†ã€‚

å®Ÿè¡Œå¾Œãƒã‚§ãƒƒã‚¯ï¼ˆå¿…é ˆï¼‰
sqlite3 /var/data/app.db "PRAGMA table_info(<table>);"


ã¾ãŸã¯

sqlite3 /var/data/app.db ".schema <table>"

ã‚ˆãã‚ã‚‹ãƒŸã‚¹ï¼ˆã“ã‚Œã‚’é˜²ããŸã‚ã®ãƒ«ãƒ¼ãƒ«ï¼‰
âŒ import ã‚¨ãƒ©ãƒ¼

åŸå› ï¼š

app_v2 ãŒ PYTHONPATH ã«ä¹—ã£ã¦ã„ãªã„

å¯¾ç­–ï¼š

migration å†…ã§ sys.path ã‚’å¼·åˆ¶è¿½åŠ 

âŒ é–“é•ã£ãŸ DB ã‚’è§¦ã‚‹

åŸå› ï¼š

sqlite3 app.db ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å©ã„ãŸ

å¯¾ç­–ï¼š

migration ã¯ å¿…ãš Render shell

ãƒ­ã‚°ã® db = /var/data/app.db ã‚’ç¢ºèª

âŒ ä½•å›ã‚‚ migration ã‚’æµã—ã¦ã—ã¾ã†

å¯¾ç­–ï¼š

migration ã¯ åŸå‰‡ 1 å›ã®ã¿

å†å®Ÿè¡Œå‰æã«ã—ãªã„

å†å®Ÿè¡ŒãŒå¿…è¦ãªå ´åˆã¯ã€Œæ–°ã—ã„ migrationã€ã‚’ä½œã‚‹

åˆ¤æ–­ã«è¿·ã£ãŸã‚‰

ã€Œã“ã‚Œã¯ migration ã‹ï¼Ÿã€â†’ DBæ§‹é€ ãŒå¤‰ã‚ã‚‹ãªã‚‰ migration

ã€Œsettings / èªè¨¼ã§ä½¿ã†ã ã‘ï¼Ÿã€â†’ DB å¤‰æ›´ä¸è¦

ã€Œä¸€æ™‚ã—ã®ãï¼Ÿã€â†’ migration ã‚’åˆ‡ã‚‰ãªã„


æœ¬ç•ªdbå¤‰æ›´æ‰‹é †

DB Migration é‹ç”¨æ‰‹é †ï¼ˆKOMET / Render + SQLiteï¼‰

ã€ç›®çš„ã€‘

Render æœ¬ç•ªã®æ°¸ç¶šãƒ‡ã‚£ã‚¹ã‚¯ï¼ˆSQLiteï¼‰ã‚’å®‰å…¨ã«å¤‰æ›´ã™ã‚‹

schema.sql ã¨å®ŸDBã®ä¸æ•´åˆã‚’é˜²ã

ã€Œå…¨æ¶ˆã—å†æ§‹ç¯‰ã€ã¨ã€Œå·®åˆ†migrationã€ã‚’æ˜ç¢ºã«ä½¿ã„åˆ†ã‘ã‚‹

0. å‰æï¼ˆé‡è¦ï¼‰

æœ¬ç•ªDBã®å®Ÿä½“ã¯ /var/data/app.db

ã‚¢ãƒ—ãƒªã‚³ãƒ¼ãƒ‰ã® schema.sql ã¯ DBã®å”¯ä¸€ã®è¨­è¨ˆå›³ï¼ˆSource of Truthï¼‰

Render Shell ã®ã‚«ãƒ¬ãƒ³ãƒˆã¯å¿…ãš: /opt/render/project/src

A. ã€å…¨æ¶ˆã—OKãªå ´åˆã€‘DBã‚’ä½œã‚Šç›´ã™æ­£è¦æ‰‹é †ï¼ˆä»Šå›ã‚„ã£ãŸæ‰‹é †ï¼‰
â‘  ãƒ­ãƒ¼ã‚«ãƒ«ã§ schema.sql ã‚’ç¢ºå®šã™ã‚‹

sqlite ã® .schema ã‚’å”¯ä¸€ã®æ­£ã¨ã—ã¦ schema.sql ã‚’ä½œã‚Šç›´ã™

ä¸­é€”åŠç«¯ãª migration ã‚’æŒŸã¾ãªã„

â‘¡ schema.sql ã ã‘ã‚’ GitHub ã« push
git add src/schema.sql
git commit -m "rebuild schema.sql from current sqlite schema"
git push

ğŸ‘‰ ã“ã®æ™‚ç‚¹ã§ã¯æœ¬ç•ªDBã«ã¯ã¾ã ä½•ã‚‚èµ·ãã¦ã„ãªã„

â‘¢ Render Shell ã§æœ¬ç•ªDBã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
cp /var/data/app.db /var/data/app.db.backup_$(date +%Y%m%d_%H%M%S)
ls -l /var/data/app.db*
â‘£ æœ¬ç•ªDBã‚’å‰Šé™¤ï¼ˆæ±ºå®šæ“ä½œï¼‰
rm /var/data/app.db
ls -l /var/data/app.db
â‘¤ schema.sql ã‹ã‚‰ DB ã‚’å†ç”Ÿæˆ
sqlite3 /var/data/app.db < src/schema.sql
â‘¥ ã‚¢ãƒ—ãƒªå†èµ·å‹•ï¼ˆRenderï¼‰

Render Dashboard â†’ Manual Deploy / Restart

B. ã€ãƒ‡ãƒ¼ã‚¿ã‚’æ®‹ã™å ´åˆã€‘migration ã‚’ä½¿ã†æ‰‹é †ï¼ˆåŸå‰‡ï¼‰
çµ¶å¯¾ãƒ«ãƒ¼ãƒ«

âŒ sqlite3 ã§æ‰‹æ‰“ã¡ ALTER ç¦æ­¢

âŒ schema.sql ã‚’ç›´æ¥ import ã—ãªã„

âœ… 1å¤‰æ›´ = 1 migration ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

migration ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆå¿…é ˆï¼‰
# scripts/migrations/mig_xxx.py
import sys
from pathlib import Path
PROJECT_ROOT = Path(__file__).resolve().parents[2]
sys.path.insert(0, str(PROJECT_ROOT))


import sqlite3
from app_v2.db.core import resolve_db_path




def migrate():
    db_path = resolve_db_path()
    print(f"[migrate] db = {db_path}")


    conn = sqlite3.connect(db_path)
    cur = conn.cursor()


    try:
        print("[migrate] begin")
        cur.execute("PRAGMA foreign_keys = OFF;")


        # --- migration å‡¦ç† ---


        conn.commit()
        print("[migrate] success")


    except Exception as e:
        conn.rollback()
        print("[migrate] failed:", e)
        raise


    finally:
        cur.execute("PRAGMA foreign_keys = ON;")
        conn.close()




if __name__ == "__main__":
    migrate()
C. åˆ¤æ–­åŸºæº–
çŠ¶æ³	æ–¹æ³•
åˆæœŸæ§‹ç¯‰ / å¤§å´©å£Šå¾Œ	A: å…¨æ¶ˆã—å†æ§‹ç¯‰
æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ä¿æŒ	B: migration
schema ã¨å®ŸDBä¹–é›¢	A
å°å¤‰æ›´	B
çµè«–

schema.sql â†’ push â†’ DBå‰Šé™¤ â†’ schema.sql import

âœ… ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã—ã¦ã‚ˆã„å ´åˆã®æ­£è§£æ‰‹é †

OKã€‚
ä»Šã®å†…å®¹ã‚’ã™ã¹ã¦åæ˜ ã—ãŸ æœ€æ–°ç‰ˆã®ã€Œæœ¬ç•ªDBå¤‰æ›´æ‰‹é †ã€ ã‚’æ›´æ–°ã—ã¦ãŠã„ãŸã€‚

çµè«–ã ã‘å†ç¢ºèª

ã‚ãªãŸã®ç†è§£ã¯ å®Œå…¨ã«æ­£ã—ã„ã€‚

ãƒ‡ãƒ¼ã‚¿ã‚’å…¨éƒ¨æ¶ˆã—ã¦ã„ã„å ´åˆã®ç†æƒ³æ‰‹é †ã¯ã“ã‚Œï¼š

ãƒ­ãƒ¼ã‚«ãƒ«ã§ schema.sql ã‚’ç¢ºå®š

.schema ã‹ã‚‰ä½œã‚Šç›´ã™

schema.sql ã‚’å”¯ä¸€ã®æ­£ã¨ã™ã‚‹

schema.sql ã ã‘ git push

ã“ã®æ™‚ç‚¹ã§ã¯æœ¬ç•ªDBã¯ã¾ã ç„¡å‚·

Render ã§æœ¬ç•ªDBã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

/var/data/app.db.backup_YYYYMMDD_HHMMSS

æœ¬ç•ªDBã‚’å‰Šé™¤

/var/data/app.db ã‚’æ¶ˆã™

schema.sql ã‚’ import

sqlite3 /var/data/app.db < src/schema.sql

Render å†èµ·å‹•

ã“ã‚Œã¯ ã€Œå…¨æ¶ˆã—å†æ§‹ç¯‰ã®æ­£è¦ãƒ«ãƒ¼ãƒˆã€ ã¨ã—ã¦ç¢ºå®šã§ã„ã„ã€‚

ä»Šå›ãƒãƒã£ãŸåŸå› ã®æœ¬è³ªï¼ˆé‡è¦ï¼‰

schema.sql ã¨å®ŸDBãŒã‚ºãƒ¬ãŸã¾ã¾

migration ã¨æ‰‹æ‰“ã¡å¤‰æ›´ãŒæ··åœ¨

line_consumer_id ãªã© éå»LINEç³»ã‚«ãƒ©ãƒ ã®äº¡éœŠ ãŒ SQL ã«æ®‹å­˜

â†’ å…¨æ¶ˆã—å†æ§‹ç¯‰ã‚’é¸ã‚“ã åˆ¤æ–­ã¯100%æ­£è§£

ä»Šå¾Œã®é‹ç”¨ãƒ«ãƒ¼ãƒ«ï¼ˆã“ã‚Œã ã‘å®ˆã‚Œã°è©°ã¾ã‚‰ãªã„ï¼‰

å…¨æ¶ˆã—OK â†’ ä»Šå›ã®æ‰‹é †ï¼ˆschema.sql å†æ§‹ç¯‰ï¼‰

ãƒ‡ãƒ¼ã‚¿ä¿æŒå¿…é ˆ â†’ migration ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã¿

âŒ æœ¬ç•ªDBã«æ‰‹æ‰“ã¡ ALTER

âŒ schema.sql ã‚’ã€Œã¨ã‚Šã‚ãˆãšæµã™ã€