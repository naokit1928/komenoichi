農家モジュール
受け渡し時刻（pickup_time）仕様書
1. この文書の目的

本書は、農家（Farmer）が設定する 受け渡し時刻スロットについて、

どこで定義され

どこまでが農家モジュールの責務で

Consumer 側とどう分離されているか

将来の変更時に壊してはいけない前提

を明文化し、時間・週・跨ぎ事故を再発させないことを目的とする。

2. 受け渡し時刻の位置づけ（最重要）
基本思想

農家が設定する受け渡し時刻は
「宣言（Declaration）」であり、「解釈（Interpretation）」ではない

つまり：

農家は
「毎週◯曜日の◯時〜◯時で渡す」
という 抽象スロット を宣言するだけ

実際に

いつの週か

何日の日付か

3時間前を過ぎているか
を判断するのは Consumer 側

3. 正のデータ（Single Source of Truth）
DB カラム
farms.pickup_time TEXT

例
SAT_10_11
WED_19_20

含まれる意味

曜日

開始時刻

終了時刻

含まれない意味（重要）

実日付

今週／来週

タイムゾーン

締切（3時間前）

👉
pickup_time は「毎週の型」であり、日時ではない

4. 農家が pickup_time を設定するフロー
4.1 初回登録（Registration）

UI
PickupTimeCardForRegistration.tsx

API
registration_api.py

Service
RegistrationService

Repo
RegistrationRepository

特徴

選択肢はフロントで enum 的に定義

農家は選択するだけ

バックエンドは値を 検証・加工せずそのまま保存

4.2 登録後の変更（Pickup Settings）

UI
PickupTimeCard.tsx

API
pickup_settings_api.py

Facade / Service
PickupSettingsFacade
PickupSettingsService

Repo
PickupSettingsRepository

変更制御

変更できるかどうかのみを判定

判定基準：

今週の active reservation が存在するか

ロック中は PickupLockedError

👉
時刻の意味を解釈しない
👉
既存予約の文脈を壊さないための安全装置

5. 農家モジュールが「やらないこと」（明示）

農家モジュールでは、以下を 一切行わない。

日付計算

今週／来週の判定

3時間前ルール

現在時刻との比較

event_start / event_end の計算

表示用日時文字列の生成

👉
pickup_time は完全に静的な宣言値

6. Consumer モジュールとの責務分離
項目	農家モジュール	Consumer モジュール
pickup_time の定義	✅	❌
日付の決定	❌	✅
週判定	❌	✅
跨ぎ防止	❌	✅
表示時刻生成	❌	✅
DB への確定保存	❌	✅

👉
役割の混在が起きていないことが、この設計の強み

7. 設計上の注意点（把握しておくべき事実）
7.1 enum がフロントにある

pickup_time の候補は

フロント側の定数定義が唯一の定義

バックエンド・DB に enum 制約はない

意味すること

今は安全

将来、更新経路を増やす場合は注意が必要

※ 現時点では 対策不要

8. 将来変更時の絶対ルール
8.1 変更してはいけないこと

pickup_time に日付を持たせる

pickup_time に週判定ロジックを入れる

農家モジュールで 3時間前ルールを扱う

Consumer 側の解釈を農家側に逆流させる

8.2 変更するなら守ること

スロット追加は

enum を増やすだけ

既存スロットの意味を変えない

pickup_time は文字列のまま維持

9. なぜこの設計が長期的に安定するか

農家は「宣言」だけ

Consumer が「解釈」だけ

時刻事故は 解釈フェーズでしか起きない

源流が静的であるほど、事故は減る

👉
非常に保守向きの設計

10. 最終まとめ（設計思想）

pickup_time は「毎週の型」

農家は意味を持たない値を宣言するだけ

Consumer が唯一の解釈者

農家モジュールは時間事故の原因にならない