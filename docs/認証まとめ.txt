認証システム設計まとめ（Email + OTP / Session方式）
1. 目的と背景

従来は LINE 認証＋リッチメニュー前提で農家向け管理画面を構築していた

LINE 認証の不安定さ・制約により Web/PWA前提の独立した認証方式に切り替える

「作り直し」ではなく、既存の farmer / reservation / settings 資産を最大限活かすことを重視

2. 採用した認証方式（結論）
✔ Email + OTP（ワンタイムパスコード）方式
✔ サーバーサイド Session 管理（Cookie）

この方式を 本採用 とし、仮実装ではない。

3. なぜ Email + OTP を採用したか
Password 方式を採用しなかった理由

管理コスト（漏洩・再設定・UI）が高い

農家ユーザー層にとって UX が重い

将来の多ユーザー（家族・従業員）拡張と相性が悪い

Email + OTP の利点

パスワード不要

実装がシンプルかつ安全

LINE / OAuth / 将来の SSO と思想的に近い

PWA / Web / 管理画面すべてで共通利用可能

4. DB 設計（認証関連）
farms テーブル（既存に追加）
ALTER TABLE farms ADD COLUMN owner_farmer_id INTEGER;
ALTER TABLE farms ADD COLUMN email TEXT;
CREATE UNIQUE INDEX idx_farms_email_unique ON farms(email);


email: 認証の主キー

owner_farmer_id: 将来の複数管理者対応のための拡張点
（現時点では farm_id と同一値をセット）

※ LINE 関連カラム（farmer_line_id, is_friend）は
　互換性維持のため現時点では未削除

OTP 用テーブル（新設・確定）
CREATE TABLE email_otp_tokens (
    otp_id INTEGER PRIMARY KEY AUTOINCREMENT,

    email TEXT NOT NULL,
    code TEXT NOT NULL,

    expires_at TEXT NOT NULL,
    consumed_at TEXT,
    attempt_count INTEGER NOT NULL DEFAULT 0,

    created_at TEXT NOT NULL
);

設計方針

主キーは otp_id に統一（id は使わない）

再利用・使い回し不可

有効期限・消費済み・試行回数を明示的に管理

将来の rate limit / lock 対応が可能

5. API 構成
認証 API（auth ドメイン）
① OTP 発行
POST /auth/request-otp


入力: email

処理:

email の存在確認

OTP 発行

DB 保存

（現状はログ出力。将来メール送信に差し替え）

② OTP 検証
POST /auth/verify-otp


入力: email + code

処理:

有効な OTP を検証

consumed_at をセット

Session に farm_id を保存

成功時:

{ "ok": true }

6. セッション管理（重要）
採用方式

SessionMiddleware（Starlette）

Cookie ベース

JWT 不使用

main.py 設定（要点）
app.add_middleware(
    SessionMiddleware,
    secret_key=SESSION_SECRET,
    same_site="lax",
    https_only=False  # 本番では True
)

セッション内容
request.session["farm_id"] = <認証済 farm_id>

この設計の意味

URL / クエリ / フロントに farm_id を出さない

すべての「農家用 API」は ME 前提で書ける

Airbnb / 管理画面系アプリと同じ思想

7. 現在の到達点（このスレッドで完了したこと）

OTP 発行 OK

OTP 検証 OK

DB / repo / service / API の整合性確保

SessionMiddleware 正常動作

requirements.txt に itsdangerous 追加済み

/auth/verify-otp が 200 OK を返すことを確認

👉 認証基盤は完成状態

8. 今後の前提（次スレッドへの引き継ぎ）
認証後の世界はこう進む

フロントは /farmer に遷移

画面下部に常時表示される Bottom Tab（ハブUI）

タブ切替で表示内容のみ変更（戻るボタン不要）

API はすべて

/api/farmer/me/...


の形式に統一

次スレッドのテーマ

👉 A方式（URLあり・BottomTab固定）のハブページ構成（React 側）

9. 設計思想の要約（重要）

認証は「一度決めたら変えない基盤」

LINE 依存を完全排除

URL に farm_id を出さない

Session を唯一の真実とする

将来の拡張（家族・従業員・権限）を壊さない