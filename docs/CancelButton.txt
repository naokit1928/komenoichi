✅ Cancel Domain V2 — 予約キャンセル機能（完全保存版 / 保守用ドキュメント）

🎯 この文書は「開発用」ではなく“今後保守・変更するときのため”に最適化しています。
どのファイルを触ればよいか、どこは触ってはいけないかを明確にした構成。

0. 目的と前提（不変ルール）

CancelDomain V2 は、

NotificationDomain（line_message_builder.py）が唯一の正準ロジック

CancelDomain は Notification の下位互換データのみ返す

独自フォーマット生成は禁止

3時間前ルールは Notification と同一の計算式を使用

キャンセル実行は CancelService → reservation_repo のみで行う

という思想で構築されている。

👉 CancelDomain に“新しいロジック”を入れてはいけない。
👉 変更が必要な場合は、NotificationDomain から変更する。

1. 全体フロー（現在の実装）
1-1. 予約確定（1通目）

line_message_builder.build_confirmation() が以下を含む：

予約内容

pickup_display

rice_items_display

受渡場所（pickup_location）

キャンセルURL（token付き）

例：
https://.../api/reservation/cancel?token=xxxx

1-2. キャンセル案内（2通目・Buttons Template）

予約確定メッセージ直後に NotificationDomain が自動送信。

文章（確定）

来れなくなった場合は必ず、3時間前までに予約の取り消しをお願いします。
無断キャンセルの場合は、次回以降のご予約を制限させていただくことがあります。


ボタン名

予約の取り消し


→ {cancel_url} を開く
※ ボタンは LINE標準テンプレート（青リンク風） に統一。

1-3. GET /cancel

ユーザーが押すと：

GET /api/reservation/cancel?token=xxx


レスポンス（下位互換データ）：

{
  "reservation_id": 284,
  "pickup_display": "...",
  "qty_5": 1,
  "qty_10": 1,
  "qty_25": 0,
  "rice_subtotal": 18000,
  "is_cancellable": true
}


※ Notification と完全同じフォーマットを生成することが絶対ルール

1-4. POST /cancel
POST /api/reservation/cancel


CancelService が以下を行う：

✔ トークン検証
✔ 予約者 LINE ID 一致チェック
✔ 3時間前ルール判定
✔ status = cancelled に更新

1-5. キャンセル完了後の “自動通知”（CANCEL_COMPLETED）

今回新しく実装したもの。

テキスト（確定）：

【キャンセルが完了しました】

（予約ID：XXX）

キャンセル手続きが正常に処理されました。
ご利用ありがとうございました。

● 送信方式（予約確定メッセージと同一方式）

CancelAPI が job を生成

即時 send_single_job(job_id)

成功 → 即ユーザーに届く

失敗 → ステータスは PENDING のまま

Worker が 1分ごとに再送（最大5回）

👉 これにより「即時送信＋再送ロジック」両方を満たす。

2. 3時間前ルール（正準仕様）

CancelService 内：

event_start = pickup開始時間  
cancel_limit = event_start - 3時間

現在時刻 > cancel_limit → キャンセル不可


エラー：

409 CANCEL_LIMIT_PASSED

3. トークン仕様

ファイル：cancel_token.py

exp          有効期限（秒）
line_user_id 予約者 LINE ID
reservation_id
sub          "cancel_reservation"


CancelDomain は必ず：

verify_cancel_token(token, allow_expired=False)


👉 有効期限切れは常にエラー

4. バックエンド内部構成（保守向け）
4-1. reservation_repo.py

触ってよい：DBの更新仕様を変えるとき

DB から予約行を取得

status=cancelled へ更新

JOIN なしの軽量仕様

4-2. cancel_service.py（最重要・変更厳禁ゾーン）

触ってよい部分：文言調整／小さな仕様変更のみ
触ってはいけない部分：3時間前ロジック・pickup_display生成

責務：

トークン → DB照合

pickup_display の生成（Notification と同一）

qty_5/10/25 の算出

is_cancellable の判定

status 更新の本体

4-3. cancel_api.py

触ってよい：HTTPエラーの文言変更／ログ追加
触ってはいけない：CancelService の結果を変える処理

今回ここに新規追加：

schedule_cancel_completed()

即時 send_single_job(job_id)

5. NotificationDomain（保守ポイントの中心）
5-1. line_message_builder.py

正準ソースコード（最優先で守るファイル）

以下を含む：

CONFIRMATION（1通目）

CANCEL_TEMPLATE（2通目）

CANCEL_COMPLETED（今回追加）

ここを変更すると CancelDomainにも影響が波及する
→ 全体の同期を考えて慎重に変更する。

5-2. line_notification_service.py

通知送信の中核。今回最も更新が入った部分。

今回の重要ロジック：

schedule_cancel_completed()

予約確定メッセージと同じ「即時送信＋Worker再送」方式を採用

Worker 仕様：

1分ごとに pending ジョブを送信

最大5回リトライ

6. 変更したい場合のガイド
A. キャンセル文言を変えたい

→ CANCEL_TEMPLATE（2通目）と
　 CANCEL_COMPLETED（今回追加）

両方のテキストを書き換えればOK。
CancelDomainには触らないこと。

B. 3時間前を2時間前にしたい

→ cancel_service.py の
cancel_limit = event_start - timedelta(hours=3)
の 3 を変更するだけ。

※ Notification とCancelDomainで同一値を使うので整合性に注意。

C. キャンセル完了通知のデザイン変更

→ line_message_builder.build_cancel_completed() だけ変更すればOK。

7. ファイル構成（キャンセル関連のみ抽出）
app_v2/
 ├ customer_booking/
 │   ├ api/
 │   │   └ cancel_api.py
 │   ├ services/
 │   │   └ cancel_service.py
 │   ├ repository/
 │   │   └ reservation_repo.py
 │   └ utils/
 │       └ cancel_token.py
 │
 ├ notifications/
 │   ├ services/
 │   │   ├ line_message_builder.py   ← 正準ロジック
 │   │   ├ line_notification_service.py ← 即時＋再送の中核
 │   │   └ reminder_schedule_service.py  ← Worker処理
 │   └ repository/
 │       └ line_notification_job_repo.py
 │
 └ docs/
     └ CancelDomainV2.md（今回の仕様書）

8. まとめ（今回の完了状態）
項目	状態
CancelDomain	完全動作。今後変更不要
NotificationDomain	CANCEL_COMPLETED を追加して完成
3時間前ルール	正準仕様として適切に動作
即時送信＋再送	正しく実装済み（予約確定と同等）
ボタンUI	元の自然な青リンク風に戻して違和感なし
全体同期	完全一致（Notification → CancelDomain）
保守の見通し	非常に良好（ファイル責務も明確）